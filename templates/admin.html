<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <title>AgriSage åå°ç®¡ç†</title>
    <link rel="stylesheet" href="static/css/admin.css">
    <link href="https://cdn.bootcss.com/sweetalert/1.1.3/sweetalert.min.css" rel="stylesheet">
    <script src="https://cdn.bootcss.com/sweetalert/1.1.3/sweetalert.min.js"></script>
    <style>
        body {
            background: url('static/img/bg7.jpg') no-repeat center center fixed;
            background-size: cover;
        }
    </style>
</head>

<body>

    <script>
        function logout() {
            // window.location.href = '/home';
            window.open('/home', '_blank');
        }
    </script>

    <div class="admin-container">
        <div class="header">
            <h1 class="admin-title">AgriSage åå°ç®¡ç†</h1>
            <div id="showtime" class="showtime"></div>
            <div id="fly" class="fly" onclick="logout()">ä¸»é¡µ</div>
        </div>

        <div class="db-config-section">
            <h3>æ•°æ®åº“è¿æ¥é…ç½®</h3>
            <div class="db-config-form">
                <div class="config-row">
                    <label for="dbType">æ•°æ®åº“ç±»å‹:</label>
                    <select id="dbType" disabled>
                        <option value="mysql">MySQL</option>
                    </select>
                </div>
                <div class="config-row">
                    <label for="dbHost">ä¸»æœº:</label>
                    <input type="text" id="dbHost" value="localhost">
                </div>
                <div class="config-row">
                    <label for="dbPort">ç«¯å£:</label>
                    <input type="text" id="dbPort" value="3306">
                </div>
                <div class="config-row">
                    <label for="dbName">æ•°æ®åº“å:</label>
                    <input type="text" id="dbName" value="display">
                </div>
                <div class="config-row">
                    <label for="dbUser">ç”¨æˆ·å:</label>
                    <input type="text" id="dbUser" value="root">
                </div>
                <div class="config-row">
                    <label for="dbPassword">å¯†ç :</label>
                    <input type="password" id="dbPassword" value="110110">
                </div>
                <div class="config-row">
                    <label for="storageMode">å­˜å‚¨æ¨¡å¼:</label>
                    <select id="storageMode">
                        <option value="database">æ•°æ®åº“</option>
                        <option value="local">æœ¬åœ°å­˜å‚¨ (å¼€å‘ä¸­)</option>
                    </select>
                </div>
                <button id="saveDbConfig" class="admin-btn">ä¿å­˜é…ç½®</button>
            </div>
        </div>

        <div class="admin-panel">
            <div class="tabs">
                <button class="tab-btn" data-tab="user">ç”¨æˆ·ç®¡ç†</button>
                <button class="tab-btn" data-tab="area">åŒºåŸŸå†œä¸šæ•°æ®</button>
                <button class="tab-btn" data-tab="weather">æ°”è±¡æ•°æ®</button>
                <button class="tab-btn" data-tab="crop">å†œäº§å“æ•°æ®</button>
            </div>

            <div id="tab-user" class="tab-content">
                <h2>ç”¨æˆ·ç®¡ç†</h2>
                <div class="admin-section">
                    <h3>æ·»åŠ /ä¿®æ”¹ç”¨æˆ·</h3>
                    <form id="userForm" class="admin-form">
                        <label for="username">ç”¨æˆ·å:</label>
                        <input type="text" id="username" required autocomplete="username">
                        <label for="password">å¯†ç :</label>
                        <div style="position: relative; display: flex; align-items: center; flex-grow: 1;">
                            <input type="password" id="password" required style="flex-grow: 1; padding-right: 30px;" autocomplete="password">
                            <span class="password-toggle" id="togglePassword"
                                style="position: absolute; right: 10px; cursor: pointer; color: #228b22; font-size: 1.2em;">ğŸ‘ï¸</span>
                        </div>
                        <label for="authority">æƒé™:</label>
                        <select id="authority" required>
                            <option value="0">æ™®é€šç”¨æˆ·</option>
                            <option value="1">ç®¡ç†å‘˜</option>
                        </select>
                        <button type="submit" class="admin-btn">æ·»åŠ /æ›´æ–°ç”¨æˆ·</button>
                    </form>
                </div>
                <div class="admin-section">
                    <h3>ç”¨æˆ·åˆ—è¡¨</h3>
                    <table id="userTable" class="admin-table">
                        <thead>
                            <tr>
                                <th>ç”¨æˆ·å</th>
                                <th>æƒé™</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="tab-area" class="tab-content">
                <h2>åŒºåŸŸå†œä¸šæ•°æ®ç®¡ç†</h2>
                <div class="admin-section">
                    <h3>æ·»åŠ /ä¿®æ”¹åŒºåŸŸæ•°æ®</h3>
                    <form id="areaForm" class="admin-form">
                        <label for="areaProv">çœä»½:</label>
                        <select id="areaProv" required>
                            <option value="">è¯·é€‰æ‹©çœä»½</option>
                            <option value="åŒ—äº¬">åŒ—äº¬</option>
                            <option value="å¤©æ´¥">å¤©æ´¥</option>
                            <option value="æ²³åŒ—">æ²³åŒ—</option>
                            <option value="å±±è¥¿">å±±è¥¿</option>
                            <option value="å†…è’™å¤">å†…è’™å¤</option>
                            <option value="è¾½å®">è¾½å®</option>
                            <option value="å‰æ—">å‰æ—</option>
                            <option value="é»‘é¾™æ±Ÿ">é»‘é¾™æ±Ÿ</option>
                            <option value="ä¸Šæµ·">ä¸Šæµ·</option>
                            <option value="æ±Ÿè‹">æ±Ÿè‹</option>
                            <option value="æµ™æ±Ÿ">æµ™æ±Ÿ</option>
                            <option value="å®‰å¾½">å®‰å¾½</option>
                            <option value="ç¦å»º">ç¦å»º</option>
                            <option value="æ±Ÿè¥¿">æ±Ÿè¥¿</option>
                            <option value="å±±ä¸œ">å±±ä¸œ</option>
                            <option value="æ²³å—">æ²³å—</option>
                            <option value="æ¹–åŒ—">æ¹–åŒ—</option>
                            <option value="æ¹–å—">æ¹–å—</option>
                            <option value="å¹¿ä¸œ">å¹¿ä¸œ</option>
                            <option value="å¹¿è¥¿">å¹¿è¥¿</option>
                            <option value="æµ·å—">æµ·å—</option>
                            <option value="é‡åº†">é‡åº†</option>
                            <option value="å››å·">å››å·</option>
                            <option value="è´µå·">è´µå·</option>
                            <option value="äº‘å—">äº‘å—</option>
                            <option value="è¥¿è—">è¥¿è—</option>
                            <option value="é™•è¥¿">é™•è¥¿</option>
                            <option value="ç”˜è‚ƒ">ç”˜è‚ƒ</option>
                            <option value="é’æµ·">é’æµ·</option>
                            <option value="å®å¤">å®å¤</option>
                            <option value="æ–°ç–†">æ–°ç–†</option>
                            <option value="é¦™æ¸¯">é¦™æ¸¯</option>
                            <option value="æ¾³é—¨">æ¾³é—¨</option>
                            <option value="å°æ¹¾">å°æ¹¾</option>
                        </select>
                        <label for="areaCropType">ä½œç‰©ç±»å‹:</label>
                        <input type="text" id="areaCropType" value="ç²®é£Ÿ" readonly>
                        <label for="areaYield">äº§é‡ (å¨):</label>
                        <input type="number" id="areaYield" step="0.01" required>
                        <button type="submit" class="admin-btn">æ·»åŠ /æ›´æ–°æ•°æ®</button>
                    </form>
                </div>
                <div class="admin-section">
                    <h3>åŒºåŸŸæ•°æ®åˆ—è¡¨</h3>
                    <table id="areaTable" class="admin-table">
                        <thead>
                            <tr>
                                <th>çœä»½</th>
                                <th>ä½œç‰©ç±»å‹</th>
                                <th>äº§é‡ (å¨)</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="tab-weather" class="tab-content">
                <h2>æ°”è±¡æ•°æ®ç®¡ç†</h2>
                <div class="admin-section">
                    <h3>æ·»åŠ /ä¿®æ”¹æ°”è±¡æ•°æ®</h3>
                    <form id="weatherForm" class="admin-form">
                        <label for="weatherDate">æ—¥æœŸ:</label>
                        <input type="date" id="weatherDate" required>
                        <label for="temp">å¹³å‡æ°”æ¸© (Â°C):</label>
                        <input type="number" id="temp" step="0.01" required>
                        <label for="wet">å¹³å‡æ¹¿åº¦ (%):</label>
                        <input type="number" id="wet" step="0.01" required>
                        <div class="break"></div>
                        <label for="sun">æ—¥ç…§å¼ºåº¦:</label>
                        <input type="number" id="sun" step="0.01" required>
                        <label for="tsoil1">åœŸå£¤æ¹¿åº¦1 (5cm):</label>
                        <input type="number" id="tsoil1" step="0.01" required>
                        <div class="break"></div>
                        <label for="tsoil2">åœŸå£¤æ¹¿åº¦2 (10cm):</label>
                        <input type="number" id="tsoil2" step="0.01" required>
                        <label for="tsoil3">åœŸå£¤æ¹¿åº¦3 (15cm):</label>
                        <input type="number" id="tsoil3" step="0.01" required>
                        <button type="submit" class="admin-btn">æ·»åŠ /æ›´æ–°æ•°æ®</button>
                    </form>
                </div>
                <div class="admin-section">
                    <h3>æ°”è±¡æ•°æ®åˆ—è¡¨</h3>
                    <table id="weatherTable" class="admin-table">
                        <thead>
                            <tr>
                                <th>æ—¥æœŸ</th>
                                <th>å¹³å‡æ°”æ¸©</th>
                                <th>å¹³å‡æ¹¿åº¦</th>
                                <th>æ—¥ç…§æ—¶æ•°</th>
                                <th>åœŸå£¤æ¹¿åº¦1</th>
                                <th>åœŸå£¤æ¹¿åº¦2</th>
                                <th>åœŸå£¤æ¹¿åº¦3</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="tab-crop" class="tab-content">
                <h2>å†œäº§å“æ•°æ®ç®¡ç†</h2>
                <div class="admin-section">
                    <h3>æ·»åŠ /ä¿®æ”¹å†œäº§å“æ•°æ®</h3>
                    <form id="cropForm" class="admin-form">
                        <!-- å·²ç§»é™¤æ—¥æœŸè¾“å…¥æ  -->
                        <label for="cropName">å†œäº§å“ç±»å‹:</label>
                        <input type="text" id="cropName" required>
                        <label for="price">ä»·æ ¼ (å…ƒ/å…¬æ–¤):</label>
                        <input type="number" id="price" step="0.01" required>
                        <div class="break"></div>
                        <label for="buy">é”€é‡ (å¨):</label>
                        <input type="number" id="buy" required>
                        <label for="cropOutput">äº§é‡ (å¨):</label>
                        <input type="number" id="cropOutput" step="0.01" required>
                        <div class="break"></div>
                        <label for="grown">ç§æ¤é¢ç§¯ (äº©):</label>
                        <input type="number" id="grown" required>
                        <label for="day">ç”Ÿé•¿æœŸ (å¤©):</label>
                        <input type="number" id="day" required>
                        <button type="submit" class="admin-btn">æ·»åŠ /æ›´æ–°æ•°æ®</button>
                    </form>
                </div>
                <div class="admin-section">
                    <h3>å†œäº§å“æ•°æ®åˆ—è¡¨</h3>
                    <table id="cropTable" class="admin-table">
                        <thead>
                            <tr>
                                <!-- å·²ç§»é™¤æ—¥æœŸåˆ— -->
                                <th>å†œäº§å“ç±»å‹</th>
                                <th>ä»·æ ¼</th>
                                <th>é”€é‡</th>
                                <th>äº§é‡</th>
                                <th>ç§æ¤é¢ç§¯</th>
                                <th>ç”Ÿé•¿æœŸ</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </div>
            </div>

        </div>
    </div>

    <script>
        // æ•°æ®åº“é…ç½®
        let DB_CONFIG = JSON.parse(localStorage.getItem('dbConfig')) || {
            dbType: 'mysql',
            dbHost: 'localhost',
            dbPort: '3306',
            dbName: 'display', // å·²ä¿®æ”¹ä¸º 'display'
            dbUser: 'root',
            dbPassword: '110110',
            storageMode: 'database' // é»˜è®¤æ•°æ®åº“æ¨¡å¼
        };

        // DOM å…ƒç´ å¼•ç”¨
        const dbHostInput = document.getElementById('dbHost');
        const dbPortInput = document.getElementById('dbPort');
        const dbNameInput = document.getElementById('dbName');
        const dbUserInput = document.getElementById('dbUser');
        const dbPasswordInput = document.getElementById('dbPassword');
        const storageModeSelect = document.getElementById('storageMode');
        const saveDbConfigBtn = document.getElementById('saveDbConfig');

        // åŠ è½½å¹¶æ˜¾ç¤ºé…ç½®
        function loadDbConfig() {
            dbHostInput.value = DB_CONFIG.dbHost;
            dbPortInput.value = DB_CONFIG.dbPort;
            dbNameInput.value = DB_CONFIG.dbName;
            dbUserInput.value = DB_CONFIG.dbUser;
            dbPasswordInput.value = DB_CONFIG.dbPassword;
            storageModeSelect.value = DB_CONFIG.storageMode;
        }

        // ä¿å­˜é…ç½®
        saveDbConfigBtn.addEventListener('click', () => {
            DB_CONFIG.dbHost = dbHostInput.value;
            DB_CONFIG.dbPort = dbPortInput.value;
            DB_CONFIG.dbName = dbNameInput.value;
            DB_CONFIG.dbUser = dbUserInput.value;
            DB_CONFIG.dbPassword = dbPasswordInput.value;
            DB_CONFIG.storageMode = storageModeSelect.value;
            localStorage.setItem('dbConfig', JSON.stringify(DB_CONFIG));
            swal('æˆåŠŸ', 'æ•°æ®åº“é…ç½®å·²ä¿å­˜ï¼', 'success');
        });

        // API æ¥å£å¯¹è±¡
        const DB_API = {
            API_BASE_URL: 'http://127.0.0.1:5000/',

            async request(endpoint, method = 'GET', data = null) {
                const url = `${this.API_BASE_URL}${endpoint}`; // ä¿®æ­£äº† BASE_URL åˆ° API_BASE_URL
                const options = {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                    },
                };
                if (data) {
                    options.body = JSON.stringify(data);
                }

                try {
                    const response = await fetch(url, options);
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.message || `è¯·æ±‚å¤±è´¥: ${response.statusText}`);
                    }
                    return await response.json();
                } catch (error) {
                    console.error(`APIè¯·æ±‚é”™è¯¯ (${method} ${endpoint}):`, error);
                    throw error;
                }
            },

            // é€šç”¨çš„æ•°æ®è·å–æ¥å£ï¼ˆåªç”¨äºGETè¯·æ±‚ï¼‰
            async getData(dataType, params = {}) {
                let endpoint = `get_${dataType}`;
                const queryParams = new URLSearchParams();
                if (params.date) {
                    queryParams.append('date', params.date);
                }
                if (queryParams.toString()) {
                    endpoint += `?${queryParams.toString()}`;
                }
                return await this.request(endpoint, 'GET');
            },

            // ç”¨æˆ·ç®¡ç†
            async getUsers() {
                return await this.request('get_users', 'GET');
            },
            async saveUser(userData) {
                // åç«¯ /update_user ä¼¼ä¹ç”¨äºä¿®æ”¹ç”¨æˆ·ï¼Œ/create ç”¨äºæ³¨å†Œæ–°ç”¨æˆ·ã€‚
                // å‡è®¾è¿™é‡Œç»Ÿä¸€ç”¨ /update_user å¤„ç†æ·»åŠ å’Œæ›´æ–°ï¼Œåç«¯éœ€è¦èƒ½è¯†åˆ«ã€‚
                return await this.request('get_users', 'POST', userData);
            },
            async deleteUser(username) {
                return await this.request('delete_user', 'POST', { username: username });
            },

            // åŒºåŸŸå†œä¸šæ•°æ®ç®¡ç†
            async getAreaData() {
                return await this.getData('area');
            },
            async saveAreaData(areaData) {
                return await this.request('get_area', 'POST', areaData);
            },
            async deleteAreaData(prov, type) {
                return await this.request('delete_area', 'POST', { prov: prov, type: type });
            },

            // æ°”è±¡æ•°æ®ç®¡ç†
            async getWeatherData(date = null) {
                return await this.getData('weather', { date: date });
            },
            async saveWeatherData(weatherData) {
                return await this.request('get_weather', 'POST', weatherData);
            },
            async deleteWeatherData(date) {
                return await this.request('delete_weather', 'POST', { date: date });
            },

            // å†œäº§å“æ•°æ®ç®¡ç†
            async getCropData(date = null) {
                return await this.getData('crop', { date: date });
            },
            async saveCropData(cropData) {
                return await this.request('get_crop', 'POST', cropData);
            },
            async deleteCropData(type) {
                return await this.request('delete_crop', 'POST', { type: type });
            },

            // ä½œç‰©ç±»å‹ç®¡ç†ï¼ˆå¦‚æœåç«¯æ²¡æœ‰ç‹¬ç«‹APIï¼Œæ­¤åŠŸèƒ½å¯èƒ½éœ€è¦è°ƒæ•´ï¼‰
            async getCropTypes() {
                // ä»å†œäº§å“æ•°æ®ä¸­æå–ä½œç‰©ç±»å‹
                const cropData = await this.getCropData();
                if (cropData && Array.isArray(cropData.type)) {
                    return [...new Set(cropData.type)].map(type => ({ type: type })); // è¿”å›å”¯ä¸€ç±»å‹
                }
                return [];
            },
            // addCropType å‡½æ•°åœ¨å‰ç«¯ï¼Œå¦‚æœåç«¯æ²¡æœ‰å¯¹åº”ç‹¬ç«‹æ¥å£ï¼Œå¯èƒ½éœ€è¦ç§»é™¤æˆ–è°ƒæ•´å…¶è¡Œä¸º
            async addCropType(newType) {
                // å‡è®¾æ·»åŠ ä½œç‰©ç±»å‹å°±æ˜¯æ·»åŠ ä¸€ä¸ªæœ€ç®€çš„ä½œç‰©è®°å½•
                return await this.saveCropData({ type: newType, price: 0, buy: 0, output: 0, grown: 0, day: 0 });
            }
        };

        // å®æ—¶æ—¶é—´æ˜¾ç¤º
        function showTime() {
            const now = new Date();
            document.getElementById('showtime').innerHTML = now.toLocaleString();
            setTimeout(showTime, 1000);
        }

        // ç”¨æˆ·ç®¡ç†
        async function listUsers() {
            const userTableBody = document.getElementById('userTable').getElementsByTagName('tbody')[0];
            userTableBody.innerHTML = '';
            if (DB_CONFIG.storageMode === 'database') {
                try {
                    const data = await DB_API.getUsers();
                    data.forEach(user => {
                        const tr = userTableBody.insertRow();
                        tr.innerHTML = `
                            <td>${user.username}</td>
                            <td>${user.anth === 1 ? 'ç®¡ç†å‘˜' : 'æ™®é€šç”¨æˆ·'}</td>
                            <td>
                                <button class="admin-btn" onclick="editUserRow('${user.username}', '${user.password}', ${user.anth})">ç¼–è¾‘</button>
                                <button class="admin-btn delete-btn" onclick="deleteUserRow('${user.username}')">åˆ é™¤</button>
                            </td>
                        `;
                    });
                } catch (error) {
                    console.error('è·å–ç”¨æˆ·åˆ—è¡¨å¤±è´¥:', error);
                    swal('é”™è¯¯', `è·å–ç”¨æˆ·åˆ—è¡¨å¤±è´¥ï¼š${error.message}`, 'error');
                }
            } else {
                swal('ä¿¡æ¯', 'æœ¬åœ°å­˜å‚¨æ¨¡å¼ä¸‹ï¼Œç”¨æˆ·ç®¡ç†åŠŸèƒ½æœªå®ç°', 'info');
            }
        }

        document.getElementById('userForm').onsubmit = async function (e) {
            e.preventDefault();
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value.trim();
            const authority = parseInt(document.getElementById('authority').value);

            if (!username) {
                swal('é”™è¯¯', 'ç”¨æˆ·åä¸èƒ½ä¸ºç©º', 'error');
                return;
            }

            const userData = { username, password, authority };

            if (DB_CONFIG.storageMode === 'database') {
                try {
                    await DB_API.saveUser(userData);
                    swal('æˆåŠŸ', 'ç”¨æˆ·å·²ä¿å­˜/æ›´æ–°ï¼', 'success');
                    this.reset();
                    listUsers();
                } catch (error) {
                    console.error('ä¿å­˜ç”¨æˆ·å¤±è´¥ (æ•°æ®åº“æ¨¡å¼):', error);
                    swal('é”™è¯¯', `æ•°æ®åº“æ“ä½œå¤±è´¥ï¼š${error.message}`, 'error');
                }
            } else {
                swal('ä¿¡æ¯', 'æœ¬åœ°å­˜å‚¨æ¨¡å¼ä¸‹ï¼Œç”¨æˆ·ä¿å­˜åŠŸèƒ½æœªå®ç°', 'info');
            }
        };

        function editUserRow(username, password, authority) {
            document.getElementById('username').value = username;
            document.getElementById('password').value = password;
            document.getElementById('authority').value = authority;
        }

        async function deleteUserRow(username) {
            if (!confirm(`ç¡®å®šè¦åˆ é™¤ç”¨æˆ· "${username}" å—ï¼Ÿ`)) return;

            if (DB_CONFIG.storageMode === 'database') {
                try {
                    await DB_API.deleteUser(username);
                    swal('æˆåŠŸ', 'ç”¨æˆ·åˆ é™¤æˆåŠŸï¼', 'success');
                    listUsers();
                } catch (error) {
                    console.error('åˆ é™¤ç”¨æˆ·å¤±è´¥ (æ•°æ®åº“æ¨¡å¼):', error);
                    swal('é”™è¯¯', `æ•°æ®åº“æ“ä½œå¤±è´¥ï¼š${error.message}`, 'error');
                }
            } else {
                swal('ä¿¡æ¯', 'æœ¬åœ°å­˜å‚¨æ¨¡å¼ä¸‹ï¼Œç”¨æˆ·åˆ é™¤åŠŸèƒ½æœªå®ç°', 'info');
            }
        }

        // åŒºåŸŸæ•°æ®ç®¡ç†
        async function renderAreaTable() {
            const areaTableBody = document.getElementById('areaTable').getElementsByTagName('tbody')[0];
            areaTableBody.innerHTML = ''; // æ¸…ç©ºè¡¨æ ¼å†…å®¹

            if (DB_CONFIG.storageMode === 'database') {
                try {
                    const data = await DB_API.getAreaData(); // è·å–åŒºåŸŸæ•°æ®
                    if (data && Array.isArray(data) && data.length > 0) {
                        data.forEach(item => {
                            const tr = areaTableBody.insertRow();
                            tr.innerHTML = `
                        <td>${item.name}</td>
                        <td>${item.type}</td>
                        <td>${item.output}</td>
                        <td>
                            <button class="admin-btn" onclick="editAreaRow('${item.name}', '${item.type}', ${item.output})">ç¼–è¾‘</button>
                            <button class="admin-btn delete-btn" onclick="deleteAreaRow('${item.name}', '${item.type}')">åˆ é™¤</button>
                        </td>
                    `;
                        });
                    } else {
                        areaTableBody.innerHTML = '<tr><td colspan="4">æš‚æ— æ•°æ®</td></tr>';
                    }
                } catch (error) {
                    console.error('è·å–åŒºåŸŸæ•°æ®å¤±è´¥:', error);
                    swal('é”™è¯¯', `è·å–åŒºåŸŸæ•°æ®å¤±è´¥ï¼š${error.message}`, 'error');
                }
            } else {
                swal('ä¿¡æ¯', 'æœ¬åœ°å­˜å‚¨æ¨¡å¼ä¸‹ï¼ŒåŒºåŸŸæ•°æ®åŠŸèƒ½æœªå®ç°', 'info');
            }
        }

        document.getElementById('areaForm').onsubmit = async function (e) {
            e.preventDefault();
            const name = document.getElementById('areaProv').value.trim();
            const type = "ç²®é£Ÿ"; // å›ºå®šä¸ºç²®é£Ÿ
            const outputVal = parseFloat(document.getElementById('areaYield').value);

            if (!name || isNaN(outputVal)) {
                swal('é”™è¯¯', 'è¯·å¡«å†™æ‰€æœ‰åŒºåŸŸæ•°æ®å­—æ®µ', 'error');
                return;
            }

            const areaData = { name: name, type: type, output: outputVal };

            if (DB_CONFIG.storageMode === 'database') {
                try {
                    await DB_API.saveAreaData(areaData);
                    swal('æˆåŠŸ', 'åŒºåŸŸæ•°æ®å·²ä¿å­˜/æ›´æ–°ï¼', 'success');
                    this.reset();
                    renderAreaTable();
                } catch (error) {
                    console.error('ä¿å­˜åŒºåŸŸæ•°æ®å¤±è´¥ (æ•°æ®åº“æ¨¡å¼):', error);
                    swal('é”™è¯¯', `æ•°æ®åº“æ“ä½œå¤±è´¥ï¼š${error.message}`, 'error');
                }
            } else {
                swal('ä¿¡æ¯', 'æœ¬åœ°å­˜å‚¨æ¨¡å¼ä¸‹ï¼ŒåŒºåŸŸæ•°æ®ä¿å­˜åŠŸèƒ½æœªå®ç°', 'info');
            }
        };

        function editAreaRow(name, type, outputVal) {
            document.getElementById('areaProv').value = name;
            document.getElementById('areaYield').value = outputVal;
        }

        async function deleteAreaRow(name, type) {
            if (!confirm(`ç¡®å®šè¦åˆ é™¤çœä»½ "${name}", ä½œç‰©ç±»å‹ "${type}" çš„åŒºåŸŸæ•°æ®å—ï¼Ÿ`)) return;

            if (DB_CONFIG.storageMode === 'database') {
                try {
                    await DB_API.deleteAreaData(name, type);
                    swal('æˆåŠŸ', 'åŒºåŸŸæ•°æ®åˆ é™¤æˆåŠŸï¼', 'success');
                    renderAreaTable();
                } catch (error) {
                    console.error('åˆ é™¤åŒºåŸŸæ•°æ®å¤±è´¥ (æ•°æ®åº“æ¨¡å¼):', error);
                    swal('é”™è¯¯', `æ•°æ®åº“æ“ä½œå¤±è´¥ï¼š${error.message}`, 'error');
                }
            } else {
                swal('ä¿¡æ¯', 'æœ¬åœ°å­˜å‚¨æ¨¡å¼ä¸‹ï¼ŒåŒºåŸŸæ•°æ®åˆ é™¤åŠŸèƒ½æœªå®ç°', 'info');
            }
        }


        // æ°”è±¡æ•°æ®ç®¡ç†
        async function renderWeatherTable() {
            const weatherTableBody = document.getElementById('weatherTable').getElementsByTagName('tbody')[0];
            weatherTableBody.innerHTML = '';
            if (DB_CONFIG.storageMode === 'database') {
                try {
                    const data = await DB_API.getWeatherData();
                    // åç«¯ /get_weather GET è¯·æ±‚è¿”å›çš„æ˜¯åˆ—è¡¨ï¼Œä¾‹å¦‚ {date:[], temp:[], ...}
                    if (data && Array.isArray(data.date) && data.date.length > 0) {
                        for (let i = 0; i < data.date.length; i++) {
                            const tr = weatherTableBody.insertRow();
                            const itemDate = data.date[i];
                            tr.innerHTML = `
                                <td>${itemDate}</td>
                                <td>${data.temp[i]}</td>
                                <td>${data.wet[i]}</td>
                                <td>${data.sun[i]}</td>
                                <td>${data.tsoil1[i]}</td>
                                <td>${data.tsoil2[i]}</td>
                                <td>${data.tsoil3[i]}</td>
                                <td>
                                    <button class="admin-btn" onclick="editWeatherRow('${itemDate}')">ç¼–è¾‘</button>
                                    <button class="admin-btn delete-btn" onclick="deleteWeatherRow('${itemDate}')">åˆ é™¤</button>
                                </td>
                            `;
                        }
                    } else {
                        weatherTableBody.innerHTML = '<tr><td colspan="8">æš‚æ— æ•°æ®</td></tr>';
                    }
                } catch (error) {
                    console.error('è·å–æ°”è±¡æ•°æ®å¤±è´¥:', error);
                    swal('é”™è¯¯', `è·å–æ°”è±¡æ•°æ®å¤±è´¥ï¼š${error.message}`, 'error');
                }
            } else {
                swal('ä¿¡æ¯', 'æœ¬åœ°å­˜å‚¨æ¨¡å¼ä¸‹ï¼Œæ°”è±¡æ•°æ®åŠŸèƒ½æœªå®ç°', 'info');
            }
        }

        // æ°”è±¡æ•°æ®è¡¨å•æäº¤å¤„ç†
        document.getElementById('weatherForm').onsubmit = async function (e) {
            e.preventDefault();
            const date = document.getElementById('weatherDate').value;
            const temp = parseFloat(document.getElementById('temp').value);
            const wet = parseFloat(document.getElementById('wet').value);
            const sun = parseFloat(document.getElementById('sun').value);
            const tsoil1 = parseFloat(document.getElementById('tsoil1').value);
            const tsoil2 = parseFloat(document.getElementById('tsoil2').value);
            const tsoil3 = parseFloat(document.getElementById('tsoil3').value);

            if (!date) {
                swal('é”™è¯¯', 'è¯·é€‰æ‹©æ—¥æœŸ', 'error');
                return;
            }

            const weatherData = { date, temp, wet, sun, tsoil1, tsoil2, tsoil3 };

            if (DB_CONFIG.storageMode === 'database') {
                try {
                    await DB_API.saveWeatherData(weatherData);
                    swal('æˆåŠŸ', 'æ°”è±¡æ•°æ®å·²ä¿å­˜/æ›´æ–°ï¼', 'success');
                    this.reset();
                    renderWeatherTable();
                } catch (error) {
                    console.error('ä¿å­˜æ°”è±¡æ•°æ®å¤±è´¥ (æ•°æ®åº“æ¨¡å¼):', error);
                    swal('é”™è¯¯', `æ•°æ®åº“æ“ä½œå¤±è´¥ï¼š${error.message}`, 'error');
                }
            } else {
                swal('ä¿¡æ¯', 'æœ¬åœ°å­˜å‚¨æ¨¡å¼ä¸‹ï¼Œæ°”è±¡æ•°æ®ä¿å­˜åŠŸèƒ½æœªå®ç°', 'info');
            }
        };

        async function editWeatherRow(date) {
            if (DB_CONFIG.storageMode === 'database') {
                try {
                    // è·å–æ‰€æœ‰æ•°æ®ï¼Œç„¶åæ‰¾åˆ°ç‰¹å®šæ—¥æœŸçš„æ•°æ®
                    const response = await DB_API.getWeatherData();
                    const index = response.date.findIndex(d => d === date);
                    if (index !== -1) {
                        const currentYear = new Date().getFullYear();
                        // å°†åç«¯è¿”å›çš„ "æœˆ-æ—¥" æ ¼å¼çš„æ—¥æœŸè¡¥å…¨ä¸º "å¹´-æœˆ-æ—¥" æ ¼å¼
                        // å‡è®¾åç«¯è¿”å›çš„ date å·²ç»æ˜¯ "MM-DD" æ ¼å¼æˆ–è€…å¯ä»¥ç›´æ¥ä¸å¹´ä»½æ‹¼æ¥
                        const fullDate = `${currentYear}-${response.date[index]}`;
                        
                        document.getElementById('weatherDate').value = fullDate;
                        document.getElementById('temp').value = response.temp[index];
                        document.getElementById('wet').value = response.wet[index];
                        document.getElementById('sun').value = response.sun[index];
                        document.getElementById('tsoil1').value = response.tsoil1[index];
                        document.getElementById('tsoil2').value = response.tsoil2[index];
                        document.getElementById('tsoil3').value = response.tsoil3[index];
                    } else {
                        swal('é”™è¯¯', 'æœªæ‰¾åˆ°è¦ç¼–è¾‘çš„æ°”è±¡æ•°æ®ï¼', 'error');
                    }
                } catch (error) {
                    console.error('ç¼–è¾‘æ—¶è·å–æ°”è±¡æ•°æ®å¤±è´¥ (æ•°æ®åº“æ¨¡å¼):', error);
                    swal('é”™è¯¯', `è·å–æ•°æ®å¤±è´¥ï¼š${error.message}`, 'error');
                }
            } else {
                swal('ä¿¡æ¯', 'æœ¬åœ°å­˜å‚¨æ¨¡å¼ä¸‹ï¼Œæ°”è±¡æ•°æ®ç¼–è¾‘åŠŸèƒ½æœªå®ç°', 'info');
            }
        }

        async function deleteWeatherRow(date) {
            if (!confirm(`ç¡®å®šè¦åˆ é™¤æ—¥æœŸ "${date}" çš„æ°”è±¡æ•°æ®å—ï¼Ÿ`)) return;

            if (DB_CONFIG.storageMode === 'database') {
                try {
                    await DB_API.deleteWeatherData(date);
                    swal('æˆåŠŸ', 'æ°”è±¡æ•°æ®åˆ é™¤æˆåŠŸï¼', 'success');
                    renderWeatherTable();
                } catch (error) {
                    console.error('åˆ é™¤æ°”è±¡æ•°æ®å¤±è´¥ (æ•°æ®åº“æ¨¡å¼):', error);
                    swal('é”™è¯¯', `æ•°æ®åº“æ“ä½œå¤±è´¥ï¼š${error.message}`, 'error');
                }
            } else {
                swal('ä¿¡æ¯', 'æœ¬åœ°å­˜å‚¨æ¨¡å¼ä¸‹ï¼Œæ°”è±¡æ•°æ®åˆ é™¤åŠŸèƒ½æœªå®ç°', 'info');
            }
        }

        // å†œäº§å“æ•°æ®ç®¡ç†
        async function renderCropTable() {
            const cropTableBody = document.getElementById('cropTable').getElementsByTagName('tbody')[0];
            cropTableBody.innerHTML = '';
            if (DB_CONFIG.storageMode === 'database') {
                try {
                    const data = await DB_API.getCropData();
                    // åç«¯ /get_crop GET è¯·æ±‚è¿”å›çš„æ˜¯åˆ—è¡¨ï¼Œä¾‹å¦‚ {type:[], price:[], ...}
                    if (data && Array.isArray(data.type) && data.type.length > 0) {
                        for (let i = 0; i < data.type.length; i++) {
                            const tr = cropTableBody.insertRow();
                            tr.innerHTML = `
                                <td>${data.type[i]}</td>
                                <td>${data.price[i]}</td>
                                <td>${data.xiaoliang[i]}</td> 
                                <td>${data.output[i]}</td>
                                <td>${data.grown[i]}</td>
                                <td>${data.day[i]}</td>
                                <td>
                                    <button class="admin-btn" onclick="editCropRow('${data.type[i]}')">ç¼–è¾‘</button>
                                    <button class="admin-btn delete-btn" onclick="deleteCropRow('${data.type[i]}')">åˆ é™¤</button>
                                </td>
                            `;
                        }
                    } else {
                        cropTableBody.innerHTML = '<tr><td colspan="7">æš‚æ— æ•°æ®</td></tr>';
                    }
                } catch (error) {
                    console.error('è·å–å†œäº§å“æ•°æ®å¤±è´¥:', error);
                    swal('é”™è¯¯', `è·å–å†œäº§å“æ•°æ®å¤±è´¥ï¼š${error.message}`, 'error');
                }
            } else {
                swal('ä¿¡æ¯', 'æœ¬åœ°å­˜å‚¨æ¨¡å¼ä¸‹ï¼Œå†œäº§å“æ•°æ®åŠŸèƒ½æœªå®ç°', 'info');
            }
        }

        // å†œäº§å“æ•°æ®è¡¨å•æäº¤å¤„ç†
        document.getElementById('cropForm').onsubmit = async function (e) {
            e.preventDefault();
            const type = document.getElementById('cropName').value.trim();
            const price = parseFloat(document.getElementById('price').value);
            const buy = parseInt(document.getElementById('buy').value);
            const output = parseInt(document.getElementById('cropOutput').value);
            const grown = parseInt(document.getElementById('grown').value);
            const day = parseInt(document.getElementById('day').value); // æ”¶è·å¤©æ•°

            if (!type || isNaN(price) || isNaN(buy) || isNaN(output) || isNaN(grown) || isNaN(day)) {
                swal('é”™è¯¯', 'è¯·å¡«å†™æ‰€æœ‰å†œäº§å“æ•°æ®å­—æ®µ', 'error');
                return;
            }

            const cropData = { type, price, buy, output, grown, day };

            if (DB_CONFIG.storageMode === 'database') {
                try {
                    await DB_API.saveCropData(cropData);
                    swal('æˆåŠŸ', 'å†œäº§å“æ•°æ®å·²ä¿å­˜/æ›´æ–°ï¼', 'success');
                    this.reset();
                    renderCropTable();
                } catch (error) {
                    console.error('ä¿å­˜å†œäº§å“æ•°æ®å¤±è´¥ (æ•°æ®åº“æ¨¡å¼):', error);
                    swal('é”™è¯¯', `æ•°æ®åº“æ“ä½œå¤±è´¥ï¼š${error.message}`, 'error');
                }
            } else {
                swal('ä¿¡æ¯', 'æœ¬åœ°å­˜å‚¨æ¨¡å¼ä¸‹ï¼Œå†œäº§å“æ•°æ®ä¿å­˜åŠŸèƒ½æœªå®ç°', 'info');
            }
        };

        async function editCropRow(type) {
            if (DB_CONFIG.storageMode === 'database') {
                try {
                    const response = await DB_API.getCropData(); // è·å–æ‰€æœ‰æ•°æ®ï¼Œç„¶åæ‰¾åˆ°ç‰¹å®šç±»å‹çš„æ•°æ®
                    const index = response.type.findIndex(t => t === type);
                    if (index !== -1) {
                        document.getElementById('cropName').value = response.type[index];
                        document.getElementById('price').value = response.price[index];
                        document.getElementById('buy').value = response.xiaoliang[index];
                        document.getElementById('cropOutput').value = response.output[index];
                        document.getElementById('grown').value = response.grown[index];
                        document.getElementById('day').value = response.day[index];
                    } else {
                        swal('é”™è¯¯', 'æœªæ‰¾åˆ°è¦ç¼–è¾‘çš„å†œäº§å“æ•°æ®ï¼', 'error');
                    }
                } catch (error) {
                    console.error('ç¼–è¾‘æ—¶è·å–å†œäº§å“æ•°æ®å¤±è´¥ (æ•°æ®åº“æ¨¡å¼):', error);
                    swal('é”™è¯¯', `è·å–æ•°æ®å¤±è´¥ï¼š${error.message}`, 'error');
                }
            } else {
                swal('ä¿¡æ¯', 'æœ¬åœ°å­˜å‚¨æ¨¡å¼ä¸‹ï¼Œå†œäº§å“æ•°æ®ç¼–è¾‘åŠŸèƒ½æœªå®ç°', 'info');
            }
        }

        async function deleteCropRow(type) {
            if (!confirm(`ç¡®å®šè¦åˆ é™¤å†œäº§å“ "${type}" çš„æ•°æ®å—ï¼Ÿ`)) return;

            if (DB_CONFIG.storageMode === 'database') {
                try {
                    await DB_API.deleteCropData(type);
                    swal('æˆåŠŸ', 'å†œäº§å“æ•°æ®åˆ é™¤æˆåŠŸï¼', 'success');
                    renderCropTable();
                } catch (error) {
                    console.error('åˆ é™¤å†œäº§å“æ•°æ®å¤±è´¥ (æ•°æ®åº“æ¨¡å¼):', error);
                    swal('é”™è¯¯', `æ•°æ®åº“æ“ä½œå¤±è´¥ï¼š${error.message}`, 'error');
                }
            } else {
                swal('ä¿¡æ¯', 'æœ¬åœ°å­˜å‚¨æ¨¡å¼ä¸‹ï¼Œå†œäº§å“æ•°æ®åˆ é™¤åŠŸèƒ½æœªå®ç°', 'info');
            }
        }

        // æ¸²æŸ“ä½œç‰©ç±»å‹åˆ—è¡¨ï¼ˆä»å†œäº§å“æ•°æ®ä¸­è·å–ï¼‰
        async function renderCropTypes() {
            const areaCropTypeSelect = document.getElementById('areaCropType');
            areaCropTypeSelect.innerHTML = ''; // æ¸…ç©ºç°æœ‰é€‰é¡¹
            // å›ºå®šä¸º"ç²®é£Ÿ"ç±»å‹
            const option = document.createElement('option');
            option.value = "ç²®é£Ÿ";
            option.textContent = "ç²®é£Ÿ";
            areaCropTypeSelect.appendChild(option);
        }

        // æ¸²æŸ“æ‰€æœ‰è¡¨æ ¼å’Œåˆ—è¡¨
        async function renderAllTables() {
            await listUsers();
            await renderCropTypes(); // å…ˆæ¸²æŸ“ä½œç‰©ç±»å‹ä»¥ä¾¿åŒºåŸŸæ•°æ®ä½¿ç”¨
            await renderAreaTable();
            await renderWeatherTable();
            await renderCropTable();
        }


        document.addEventListener('DOMContentLoaded', async () => {
            showTime();
            loadDbConfig();

            // éšè—æ‰€æœ‰æ¿å—
            document.querySelectorAll('.tab-content').forEach(content => {
                content.style.display = 'none';
            });

            // æ˜¾ç¤ºç”¨æˆ·ç®¡ç†æ¿å—
            document.getElementById('tab-user').style.display = 'block';
            document.querySelector('.tab-btn[data-tab="user"]').classList.add('active');

            // åŠ è½½æ‰€æœ‰è¡¨æ ¼æ•°æ®
            await renderAllTables();

            // æ·»åŠ  Tab åˆ‡æ¢é€»è¾‘
            document.querySelectorAll('.tab-btn').forEach(button => {
                button.addEventListener('click', function () {
                    // éšè—æ‰€æœ‰æ¿å—
                    document.querySelectorAll('.tab-content').forEach(content => {
                        content.style.display = 'none';
                    });

                    // ç§»é™¤æ‰€æœ‰æŒ‰é’®çš„æ¿€æ´»çŠ¶æ€
                    document.querySelectorAll('.tab-btn').forEach(btn => {
                        btn.classList.remove('active');
                    });

                    // æ˜¾ç¤ºå½“å‰æ¿å—å¹¶æ¿€æ´»æŒ‰é’®
                    const tab = this.dataset.tab;
                    document.getElementById(`tab-${tab}`).style.display = 'block';
                    this.classList.add('active');

                    // åˆ·æ–°å¯¹åº”æ¿å—æ•°æ®
                    if (tab === 'area') {
                        renderAreaTable();
                    } else if (tab === 'weather') {
                        renderWeatherTable();
                    } else if (tab === 'crop') {
                        renderCropTable();
                    } else if (tab === 'user') {
                        listUsers();
                    }
                });
            });
        });


        // æŸ¥æ‰¾å¯†ç è¾“å…¥æ¡†å’Œåˆ‡æ¢å›¾æ ‡
        const passwordInput = document.getElementById('password');
        const togglePassword = document.getElementById('togglePassword');

        // ç¡®ä¿è¿™ä¸¤ä¸ªå…ƒç´ éƒ½å­˜åœ¨ï¼Œé¿å…æŠ¥é”™
        if (passwordInput && togglePassword) {
            // ä¸ºåˆ‡æ¢å›¾æ ‡æ·»åŠ ç‚¹å‡»äº‹ä»¶ç›‘å¬å™¨
            togglePassword.addEventListener('click', function () {
                // æ£€æŸ¥å½“å‰è¾“å…¥æ¡†çš„ç±»å‹
                const currentType = passwordInput.getAttribute('type');
                const newType = currentType === 'password' ? 'text' : 'password';
                // åˆ‡æ¢è¾“å…¥æ¡†çš„ç±»å‹
                if (newType === 'text' || newType === 'password') {
                    passwordInput.setAttribute('type', newType);

                    // æ ¹æ®æ–°çš„ç±»å‹åˆ‡æ¢å›¾æ ‡æ˜¾ç¤ºï¼ˆä¾‹å¦‚ï¼Œä»â€œçœ¼ç›â€åˆ°â€œé”â€æˆ–â€œæ–œæ çœ¼ç›â€ï¼‰
                    // æ‚¨å¯ä»¥æ ¹æ®å–œå¥½ä¿®æ”¹è¿™é‡Œçš„ emoji æˆ–è€… class æ¥åˆ‡æ¢å›¾æ ‡
                    this.textContent = (newType === 'password' ? 'ğŸ‘ï¸' : 'ğŸ”’'); // åˆ‡æ¢å›¾æ ‡æ–‡æœ¬
                }
            });
        }



    </script>
</body>

</html>