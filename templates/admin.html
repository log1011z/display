<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>AgriSage åå°ç®¡ç†</title>
    <link rel="stylesheet" href="{{url_for('static',filename='css/styles.css')}}">
    <link href="https://cdn.bootcss.com/sweetalert/1.1.3/sweetalert.min.css" rel="stylesheet">
    <script src="{{ url_for('static',filename='js/sweetalert2.js')}}"></script>
    <script>
        // ç”¨æˆ·è´¦å·ç®¡ç†åŠŸèƒ½
        let users = [];
        
        // æ·»åŠ ç”¨æˆ·
        function addUser() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            if (!username || !password) {
                swal('é”™è¯¯', 'ç”¨æˆ·åå’Œå¯†ç ä¸èƒ½ä¸ºç©º', 'error');
                return;
            }
            
            users.push({username, password});
            swal('æˆåŠŸ', 'ç”¨æˆ·æ·»åŠ æˆåŠŸ', 'success');
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            listUsers();
        }
        
        // åˆ é™¤ç”¨æˆ·
        function deleteUser() {
            const username = document.getElementById('username').value;
            
            if (!username) {
                swal('é”™è¯¯', 'è¯·è¾“å…¥è¦åˆ é™¤çš„ç”¨æˆ·å', 'error');
                return;
            }
            
            const index = users.findIndex(u => u.username === username);
            if (index === -1) {
                swal('é”™è¯¯', 'ç”¨æˆ·ä¸å­˜åœ¨', 'error');
                return;
            }
            
            users.splice(index, 1);
            swal('æˆåŠŸ', 'ç”¨æˆ·åˆ é™¤æˆåŠŸ', 'success');
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            listUsers();
        }
        
        // ä¿®æ”¹å¯†ç 
        function updateUser() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            if (!username || !password) {
                swal('é”™è¯¯', 'ç”¨æˆ·åå’Œæ–°å¯†ç ä¸èƒ½ä¸ºç©º', 'error');
                return;
            }
            
            const user = users.find(u => u.username === username);
            if (!user) {
                swal('é”™è¯¯', 'ç”¨æˆ·ä¸å­˜åœ¨', 'error');
                return;
            }
            
            user.password = password;
            swal('æˆåŠŸ', 'å¯†ç ä¿®æ”¹æˆåŠŸ', 'success');
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            listUsers();
        }
        
        // æŸ¥çœ‹ç”¨æˆ·åˆ—è¡¨
        function listUsers() {
            const userList = document.getElementById('userList');
            userList.innerHTML = '<h4>ç”¨æˆ·åˆ—è¡¨</h4>';
            
            if (users.length === 0) {
                userList.innerHTML += '<p>æš‚æ— ç”¨æˆ·</p>';
                return;
            }
            
            users.forEach(user => {
                userList.innerHTML += 
                    `<div style="margin-bottom: 5px;">
                        <span style="font-weight: bold;">${user.username}</span>
                        <span style="margin-left: 10px;">å¯†ç : ${'*'.repeat(user.password.length)}</span>
                    </div>`;
            });
        }
    </script>
    
    <style>
        body {
            background: url("{{url_for('static',filename='img/bg7.jpg')}}") no-repeat center center fixed;
            background-size: cover;
        }
        .admin-container {
            max-width: 900px;
            margin: 40px auto;
            background: rgba(255,255,255,0.85);
            border-radius: 18px;
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.18);
            padding: 36px 32px 32px 32px;
        }
        .admin-title {
            font-size: 2.2rem;
            font-weight: bold;
            text-align: center;
            margin-bottom: 30px;
            color: #228b22;
            letter-spacing: 2px;
            background: linear-gradient(90deg, #b7eb8f 0%, #52c41a 50%, #e8f5e8 100%);
            border-radius: 12px;
            padding: 12px 0;
            box-shadow: 0 2px 8px rgba(34,139,34,0.08);
        }
        .admin-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 24px;
            background: #fff;
            border-radius: 10px;
            overflow: hidden;
        }
        .admin-table th, .admin-table td {
            padding: 12px 8px;
            text-align: center;
            border-bottom: 1px solid #e0e0e0;
        }
        .admin-table th {
            background: #e8f5e8;
            color: #228b22;
            font-size: 1.1rem;
        }
        .admin-table tr:last-child td {
            border-bottom: none;
        }
        .admin-btn {
            background: linear-gradient(90deg, #52c41a 0%, #b7eb8f 100%);
            color: #fff;
            border: none;
            border-radius: 6px;
            padding: 6px 16px;
            margin: 0 4px;
            font-size: 1rem;
            cursor: pointer;
            transition: background 0.2s;
        }
        .admin-btn:hover {
            background: linear-gradient(90deg, #228b22 0%, #95de64 100%);
        }
        .admin-form {
            display: flex;
            gap: 12px;
            margin-bottom: 18px;
            flex-wrap: wrap;
            align-items: center;
        }
        .admin-form input, .admin-form select {
            padding: 6px 10px;
            border: 1px solid #b7eb8f;
            border-radius: 5px;
            font-size: 1rem;
        }
        .admin-form label {
            font-weight: 500;
            color: #228b22;
        }
        .tab-group {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
            gap: 15px;
        }
        .tab-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            background: #f0f0f0;
            cursor: pointer;
            font-size: 1.1rem;
            transition: background 0.3s, color 0.3s;
            color: #333;
        }
        .tab-btn:hover {
            background: #e0e0e0;
        }
        .tab-btn.active {
            background: linear-gradient(90deg, #52c41a 0%, #b7eb8f 100%);
            color: #fff;
        }
        .date-select-group {
            text-align: center;
            margin-bottom: 20px;
        }
        .showtime {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.9);
            padding: 10px 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            font-size: 14px;
            color: #228b22;
            font-weight: bold;
            z-index: 1000;
        }
        .tab-content {
            display: block; /* Default to block */
        }
        .crop-type-section {
            margin-bottom: 20px;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 10px;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
        }
        .crop-type-list {
            margin-top: 15px;
        }
        .crop-type-list h4 {
            margin-bottom: 10px;
        }
        .crop-type-list div {
            background: #e8f5e8;
            color: #228b22;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.9rem;
            font-weight: bold;
        }
        .db-config-section {
            margin-bottom: 20px;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 10px;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
        }
        .db-config-form {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .config-row {
            display: flex;
            gap: 15px;
            align-items: center;
        }
        .config-row label {
            flex: 1;
            font-weight: 500;
            color: #228b22;
        }
        .config-row input[type="text"], .config-row input[type="number"], .config-row select {
            padding: 6px 10px;
            border: 1px solid #b7eb8f;
            border-radius: 5px;
            font-size: 1rem;
        }
        .config-row button {
            padding: 6px 16px;
            font-size: 0.9rem;
        }
        @media (max-width: 600px) {
            .admin-container { padding: 10px; }
            .admin-title { font-size: 1.2rem; }
            .tab-group { flex-direction: column; }
            .tab-btn { width: 100%; padding: 8px 15px; }
            .admin-table th, .admin-table td { padding: 6px 2px; font-size: 0.9rem; }
            .admin-form { flex-direction: column; gap: 6px; }
            .config-row { flex-direction: column; align-items: flex-start; }
            .config-row label { width: 100%; text-align: left; }
            .config-row input[type="text"], .config-row input[type="number"], .config-row select { width: 100%; }
        }
    </style>
</head>
<body>
    <!-- å®æ—¶æ—¶é—´æ˜¾ç¤º -->
    <div class="showtime" id="showtime"></div>
    
    <div class="admin-container">
        <div class="admin-title">ğŸŒ¾ AgriSage åå°ç®¡ç† ğŸŒ¾</div>
        
        <!-- æ•°æ®åº“è¿æ¥é…ç½®çª—å£ -->
        <div class="db-config-section">
            <h3 style="color: #228b22; margin-bottom: 15px;">ğŸ”— æ•°æ®åº“è¿æ¥é…ç½®</h3>
            <div class="db-config-form">
                <div class="config-row">
                    <label>æ•°æ®åº“ç±»å‹ï¼š
                        <select id="dbType">
                            <option value="mysql">MySQL</option>
                        </select>
                    </label>
                    <label>ä¸»æœºåœ°å€ï¼š<input type="text" id="dbHost" value="localhost" placeholder="localhost"></label>
                    <label>ç«¯å£ï¼š<input type="number" id="dbPort" value="3306" placeholder="3306"></label>
                </div>
                <div class="config-row">
                    <label>æ•°æ®åº“åï¼š<input type="text" id="dbName" value="myollama" placeholder="myollama"></label>
                    <label>ç”¨æˆ·åï¼š<input type="text" id="dbUser" value="root" placeholder="root"></label>
                    <label>å¯†ç ï¼š<input type="password" id="dbPassword" placeholder="è¯·è¾“å…¥å¯†ç "></label>
                </div>
                <div class="config-row">
                    <button class="admin-btn" onclick="testDbConnection()">æµ‹è¯•è¿æ¥</button>
                    <button class="admin-btn" onclick="saveDbConfig()">ä¿å­˜é…ç½®</button>
                    <button class="admin-btn" onclick="toggleStorageMode()">åˆ‡æ¢å­˜å‚¨æ¨¡å¼</button>
                    <span id="connectionStatus" style="margin-left: 10px; font-weight: bold;"></span>
                </div>
                <div class="config-row" style="justify-content: center; margin-top: 10px;">
                    <span class="mode-label">å½“å‰å­˜å‚¨æ¨¡å¼ï¼š</span>
                    <span id="storageModeDisplay" class="mode-value"></span>
                </div>
            </div>
        </div>
        
        <!-- ç”¨æˆ·è´¦å·ç®¡ç†æ¨¡å— -->
        <div class="db-config-section" style="margin-top: 20px;">
            <h3 style="color: #228b22; margin-bottom: 15px;">ğŸ‘¥ ç”¨æˆ·è´¦å·ç®¡ç†</h3>
            <div class="db-config-form">
                <div class="config-row">
                    <label>ç”¨æˆ·åï¼š<input type="text" id="username" placeholder="è¯·è¾“å…¥ç”¨æˆ·å"></label>
                    <label>å¯†ç ï¼š<input type="password" id="password" placeholder="è¯·è¾“å…¥å¯†ç "></label>
                </div>
                <div class="config-row">
                    <button class="admin-btn" onclick="addUser()">æ·»åŠ ç”¨æˆ·</button>
                    <button class="admin-btn" onclick="deleteUser()">åˆ é™¤ç”¨æˆ·</button>
                    <button class="admin-btn" onclick="updateUser()">ä¿®æ”¹å¯†ç </button>
                    <button class="admin-btn" onclick="listUsers()">æŸ¥çœ‹ç”¨æˆ·</button>
                </div>
                <div class="config-row" style="margin-top: 10px;">
                    <div id="userList" style="width: 100%; border: 1px solid #ddd; padding: 10px; min-height: 100px;"></div>
                </div>
            </div>
        </div>
        
        <div class="tab-group">
            <button class="tab-btn active" data-tab="province">çœä»½å†œä¸šæ•°æ®</button>
            <button class="tab-btn" data-tab="sensor">ä¼ æ„Ÿå™¨æ•°æ®</button>
            <button class="tab-btn" data-tab="product">ä»·æ ¼ä¸é”€é‡</button>
        </div>
        <div class="date-select-group">
            <label>é€‰æ‹©æ—¥æœŸï¼š<input type="date" id="datePicker"></label>
        </div>
        <div id="tab-province" class="tab-content active">
            <!-- ä½œç‰©ç±»å‹ç®¡ç† -->
            <div class="crop-type-section">
                <h3 style="color: #228b22; margin-bottom: 15px;">ğŸŒ± ä½œç‰©ç±»å‹ç®¡ç†</h3>
                <form class="admin-form" id="cropTypeForm" style="margin-bottom: 20px;">
                    <label>æ–°å¢ä½œç‰©ç±»å‹ï¼š<input type="text" id="newCropType" placeholder="è¯·è¾“å…¥ä½œç‰©ç±»å‹åç§°" required></label>
                    <button type="submit" class="admin-btn">æ·»åŠ ä½œç‰©ç±»å‹</button>
                </form>
                <div class="crop-type-list">
                    <h4 style="color: #52c41a; margin-bottom: 10px;">å½“å‰ä½œç‰©ç±»å‹ï¼š</h4>
                    <div id="cropTypeList" style="display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px;"></div>
                </div>
            </div>
            
            <!-- çœä»½å†œä¸šæ•°æ®è¡¨å•å’Œè¡¨æ ¼ï¼ˆåŸæœ‰å†…å®¹ï¼‰ -->
            <h3 style="color: #228b22; margin-bottom: 15px;">ğŸ—ºï¸ çœä»½å†œä¸šæ•°æ®</h3>
            <form class="admin-form" id="addForm">
                <label>çœä»½ï¼š
                    <select id="province" required>
                        <option value="">è¯·é€‰æ‹©çœä»½</option>
                        <option value="åŒ—äº¬">åŒ—äº¬</option>
                        <option value="å¤©æ´¥">å¤©æ´¥</option>
                        <option value="æ²³åŒ—">æ²³åŒ—</option>
                        <option value="å±±è¥¿">å±±è¥¿</option>
                        <option value="å†…è’™å¤">å†…è’™å¤</option>
                        <option value="è¾½å®">è¾½å®</option>
                        <option value="å‰æ—">å‰æ—</option>
                        <option value="é»‘é¾™æ±Ÿ">é»‘é¾™æ±Ÿ</option>
                        <option value="ä¸Šæµ·">ä¸Šæµ·</option>
                        <option value="æ±Ÿè‹">æ±Ÿè‹</option>
                        <option value="æµ™æ±Ÿ">æµ™æ±Ÿ</option>
                        <option value="å®‰å¾½">å®‰å¾½</option>
                        <option value="ç¦å»º">ç¦å»º</option>
                        <option value="æ±Ÿè¥¿">æ±Ÿè¥¿</option>
                        <option value="å±±ä¸œ">å±±ä¸œ</option>
                        <option value="æ²³å—">æ²³å—</option>
                        <option value="æ¹–åŒ—">æ¹–åŒ—</option>
                        <option value="æ¹–å—">æ¹–å—</option>
                        <option value="å¹¿ä¸œ">å¹¿ä¸œ</option>
                        <option value="å¹¿è¥¿">å¹¿è¥¿</option>
                        <option value="æµ·å—">æµ·å—</option>
                        <option value="é‡åº†">é‡åº†</option>
                        <option value="å››å·">å››å·</option>
                        <option value="è´µå·">è´µå·</option>
                        <option value="äº‘å—">äº‘å—</option>
                        <option value="è¥¿è—">è¥¿è—</option>
                        <option value="é™•è¥¿">é™•è¥¿</option>
                        <option value="ç”˜è‚ƒ">ç”˜è‚ƒ</option>
                        <option value="é’æµ·">é’æµ·</option>
                        <option value="å®å¤">å®å¤</option>
                        <option value="æ–°ç–†">æ–°ç–†</option>
                    </select>
                </label>
                <label>ä½œç‰©ç±»å‹ï¼š
                    <select id="cropType">
                        <option value="ç²®é£Ÿ">ç²®é£Ÿ</option>
                        <option value="è”¬èœ">è”¬èœ</option>
                        <option value="æ°´æœ">æ°´æœ</option>
                        <option value="æ²¹æ–™">æ²¹æ–™</option>
                        <option value="å…¶ä»–">å…¶ä»–</option>
                    </select>
                </label>
                <label>äº§é‡(å¨)ï¼š<input type="number" id="output" min="0" max="10000" step="0.1" required></label>
                <button type="submit" class="admin-btn">æ·»åŠ /æ›´æ–°</button>
            </form>
            <table class="admin-table" id="dataTable">
                <thead>
                    <tr>
                        <th>çœä»½</th>
                        <th>ä½œç‰©ç±»å‹</th>
                        <th>äº§é‡(å¨)</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
        <div id="tab-sensor" class="tab-content" style="display:none">
            <!-- ä¼ æ„Ÿå™¨æ•°æ®ç®¡ç†å†…å®¹ -->
            <form class="admin-form" id="sensorForm">
                <label>æ¸©åº¦(â„ƒ)ï¼š<input type="number" id="temp" step="0.1" min="-50" max="100" placeholder="-50åˆ°100"></label>
                <label>æ¹¿åº¦(%)ï¼š<input type="number" id="humidity" step="0.1" min="0" max="100" placeholder="0åˆ°100"></label>
                <label>å…‰ç…§(lux)ï¼š<input type="number" id="sunlight" step="1" min="0" max="10000" placeholder="0åˆ°10000"></label>
                <label>åœŸå£¤1å±‚(%)ï¼š<input type="number" id="soil1" step="0.1" min="0" max="100" placeholder="0åˆ°100"></label>
                <label>åœŸå£¤2å±‚(%)ï¼š<input type="number" id="soil2" step="0.1" min="0" max="100" placeholder="0åˆ°100"></label>
                <label>åœŸå£¤3å±‚(%)ï¼š<input type="number" id="soil3" step="0.1" min="0" max="100" placeholder="0åˆ°100"></label>
                <button type="submit" class="admin-btn">æ·»åŠ /æ›´æ–°</button>
            </form>
            <table class="admin-table" id="sensorTable">
                <thead>
                    <tr>
                        <th>æ—¥æœŸ</th>
                        <th>æ¸©åº¦(â„ƒ)</th>
                        <th>æ¹¿åº¦(%)</th>
                        <th>å…‰ç…§(lux)</th>
                        <th>åœŸå£¤1å±‚(%)</th>
                        <th>åœŸå£¤2å±‚(%)</th>
                        <th>åœŸå£¤3å±‚(%)</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
        <div id="tab-product" class="tab-content" style="display:none">
            <!-- ä»·æ ¼ä¸é”€é‡ç®¡ç†å†…å®¹ -->
            <form class="admin-form" id="productForm">
                <label>å†œäº§å“ï¼š
                    <select id="productName" required>
                        <option value="">è¯·é€‰æ‹©å†œäº§å“</option>
                        <option value="æ°´ç¨»">æ°´ç¨»</option>
                        <option value="å°éº¦">å°éº¦</option>
                        <option value="ç‰ç±³">ç‰ç±³</option>
                        <option value="å¤§è±†">å¤§è±†</option>
                        <option value="è”¬èœ">è”¬èœ</option>
                        <option value="æ°´æœ">æ°´æœ</option>
                    </select>
                </label>
                <label>ä»·æ ¼(å…ƒ/æ–¤)ï¼š<input type="number" id="price" step="0.1" min="0.1" max="20" required></label>
                <label>é”€é‡(å¨)ï¼š<input type="number" id="sales" step="0.1" min="1" max="5000" required></label>
                <label>äº§é‡(å¨)ï¼š<input type="number" id="yield" step="0.1" min="1" max="5000" required></label>
                <label>æ”¶æˆå¤©æ•°ï¼š<input type="number" id="harvestDays" step="1" min="30" max="300" required></label>
                <button type="submit" class="admin-btn">æ·»åŠ /æ›´æ–°</button>
            </form>
            <table class="admin-table" id="productTable">
                <thead>
                    <tr>
                        <th>æ—¥æœŸ</th>
                        <th>å†œäº§å“</th>
                        <th>ä»·æ ¼(å…ƒ/æ–¤)</th>
                        <th>é”€é‡(å¨)</th>
                        <th>äº§é‡(å¨)</th>
                        <th>æ”¶æˆå¤©æ•°</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
    <script>
        // æœ¬åœ°å­˜å‚¨key
        const STORAGE_KEY = 'agri_province_data';
        const SENSOR_STORAGE_KEY = 'agri_sensor_data';
        const PRODUCT_STORAGE_KEY = 'agri_product_data';
        
        // é»˜è®¤æ•°æ®
        const defaultData = [
            {name: 'åŒ—äº¬', type: 'ç²®é£Ÿ', output: 1200},
            {name: 'å¤©æ´¥', type: 'è”¬èœ', output: 800},
            {name: 'æ²³åŒ—', type: 'ç²®é£Ÿ', output: 1500},
            {name: 'å±±è¥¿', type: 'æ²¹æ–™', output: 600},
            {name: 'å†…è’™å¤', type: 'ç²®é£Ÿ', output: 900}
        ];
        
        // é»˜è®¤ä¼ æ„Ÿå™¨æ•°æ®
        const defaultSensorData = {
            '2024-12-01': {temp: 25, humidity: 65, sunlight: 1000, soil1: 20, soil2: 18, soil3: 15},
            '2024-12-02': {temp: 27, humidity: 72, sunlight: 1200, soil1: 22, soil2: 19, soil3: 16},
            '2024-12-03': {temp: 23, humidity: 68, sunlight: 1500, soil1: 21, soil2: 20, soil3: 17}
        };
        
        // é»˜è®¤ä»·æ ¼é”€é‡æ•°æ®
        const defaultProductData = {
            '2024-12-01': [
                {name: 'æ°´ç¨»', price: 2.5, sales: 1200, yield: 1500, harvestDays: 120},
                {name: 'å°éº¦', price: 2.8, sales: 800, yield: 1000, harvestDays: 110},
                {name: 'ç‰ç±³', price: 2.2, sales: 1500, yield: 1800, harvestDays: 100},
                {name: 'å¤§è±†', price: 3.5, sales: 600, yield: 800, harvestDays: 130},
                {name: 'è”¬èœ', price: 1.8, sales: 2000, yield: 2500, harvestDays: 60},
                {name: 'æ°´æœ', price: 4.2, sales: 900, yield: 1200, harvestDays: 180}
            ]
        };
        
        // è·å–æ•°æ®
        function getData() {
            const data = localStorage.getItem(STORAGE_KEY);
            return data ? JSON.parse(data) : defaultData;
        }
        
        // è·å–ä¼ æ„Ÿå™¨æ•°æ®
        function getSensorData() {
            const data = localStorage.getItem(SENSOR_STORAGE_KEY);
            return data ? JSON.parse(data) : defaultSensorData;
        }
        
        // è·å–ä»·æ ¼é”€é‡æ•°æ®
        function getProductData() {
            const data = localStorage.getItem(PRODUCT_STORAGE_KEY);
            return data ? JSON.parse(data) : defaultProductData;
        }
        
        // ä¿å­˜æ•°æ®
        function saveData(data) {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
        }
        
        // ä¿å­˜ä¼ æ„Ÿå™¨æ•°æ®
        function saveSensorData(data) {
            localStorage.setItem(SENSOR_STORAGE_KEY, JSON.stringify(data));
        }
        
        // ä¿å­˜ä»·æ ¼é”€é‡æ•°æ®
        function saveProductData(data) {
            localStorage.setItem(PRODUCT_STORAGE_KEY, JSON.stringify(data));
        }
        
        // æ¸²æŸ“è¡¨æ ¼
        function renderTable() {
            if (DB_CONFIG.storageMode === 'database') {
                // æ•°æ®åº“æ¨¡å¼ï¼šä»APIè·å–æ•°æ®
                DB_API.getCropData().then(data => {
                    if (data && Array.isArray(data)) {
                        const tbody = document.querySelector('#dataTable tbody');
                        tbody.innerHTML = '';
                        data.forEach((item, idx) => {
                            const tr = document.createElement('tr');
                            tr.innerHTML = `
                                <td>${item.type}</td>
                                <td>${item.type}</td>
                                <td>${item.output || 0}</td>
                                <td>
                                    <button class="admin-btn" onclick="editRow('${item.type}')">ç¼–è¾‘</button>
                                    <button class="admin-btn" onclick="deleteRow('${item.type}')">åˆ é™¤</button>
                                </td>
                            `;
                            tbody.appendChild(tr);
                        });
                    }
                }).catch(error => {
                    console.error('è·å–æ•°æ®å¤±è´¥:', error);
                    // å¤±è´¥æ—¶ä½¿ç”¨æœ¬åœ°å­˜å‚¨
                    renderLocalTable();
                });
            } else {
                // æœ¬åœ°å­˜å‚¨æ¨¡å¼
                renderLocalTable();
            }
        }
        
        function renderLocalTable() {
            const data = getData();
            const tbody = document.querySelector('#dataTable tbody');
            tbody.innerHTML = '';
            data.forEach((item, idx) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${item.name}</td>
                    <td>${item.type}</td>
                    <td>${item.output}</td>
                    <td>
                        <button class="admin-btn" onclick="editRow(${idx})">ç¼–è¾‘</button>
                        <button class="admin-btn" onclick="deleteRow(${idx})">åˆ é™¤</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }
        
        // æ¸²æŸ“ä¼ æ„Ÿå™¨è¡¨æ ¼
        function renderSensorTable() {
            const selectedDate = document.getElementById('datePicker').value;
            const tbody = document.querySelector('#sensorTable tbody');
            tbody.innerHTML = '';
            
            if (DB_CONFIG.storageMode === 'database') {
                // æ•°æ®åº“æ¨¡å¼ï¼šä»APIè·å–æ•°æ®
                DB_API.getWeatherData(selectedDate).then(data => {
                    if (data && data[selectedDate]) {
                        const item = data[selectedDate];
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td>${selectedDate}</td>
                            <td>${item.temp || '--'}</td>
                            <td>${item.wet || '--'}</td>
                            <td>${item.sun || '--'}</td>
                            <td>${item.tsoil1 || '--'}</td>
                            <td>${item.tsoil2 || '--'}</td>
                            <td>${item.tsoil3 || '--'}</td>
                            <td>
                                <button class="admin-btn" onclick="editSensorRow()">ç¼–è¾‘</button>
                                <button class="admin-btn" onclick="deleteSensorRow()">åˆ é™¤</button>
                            </td>
                        `;
                        tbody.appendChild(tr);
                    }
                }).catch(error => {
                    console.error('è·å–ä¼ æ„Ÿå™¨æ•°æ®å¤±è´¥:', error);
                    // å¤±è´¥æ—¶ä½¿ç”¨æœ¬åœ°å­˜å‚¨
                    renderLocalSensorTable();
                });
            } else {
                // æœ¬åœ°å­˜å‚¨æ¨¡å¼
                renderLocalSensorTable();
            }
        }
        
        function renderLocalSensorTable() {
            const data = getSensorData();
            const selectedDate = document.getElementById('datePicker').value;
            const tbody = document.querySelector('#sensorTable tbody');
            tbody.innerHTML = '';
            
            if (data[selectedDate]) {
                const item = data[selectedDate];
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${selectedDate}</td>
                    <td>${item.temp || '--'}</td>
                    <td>${item.humidity || '--'}</td>
                    <td>${item.sunlight || '--'}</td>
                    <td>${item.soil1 || '--'}</td>
                    <td>${item.soil2 || '--'}</td>
                    <td>${item.soil3 || '--'}</td>
                    <td>
                        <button class="admin-btn" onclick="editSensorRow()">ç¼–è¾‘</button>
                        <button class="admin-btn" onclick="deleteSensorRow()">åˆ é™¤</button>
                    </td>
                `;
                tbody.appendChild(tr);
            }
        }
        
        // æ¸²æŸ“ä»·æ ¼é”€é‡è¡¨æ ¼
        function renderProductTable() {
            const data = getProductData();
            const selectedDate = document.getElementById('datePicker').value;
            const tbody = document.querySelector('#productTable tbody');
            tbody.innerHTML = '';
            
            if (data[selectedDate]) {
                data[selectedDate].forEach((item, idx) => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${selectedDate}</td>
                        <td>${item.name}</td>
                        <td>${item.price}</td>
                        <td>${item.sales}</td>
                        <td>${item.yield}</td>
                        <td>${item.harvestDays}</td>
                        <td>
                            <button class="admin-btn" onclick="editProductRow(${idx})">ç¼–è¾‘</button>
                            <button class="admin-btn" onclick="deleteProductRow(${idx})">åˆ é™¤</button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            }
        }
        
        // äº§é‡éªŒè¯å‡½æ•°
        function validateOutput(output, province, cropType) {
            // æ ¹æ®çœä»½å’Œä½œç‰©ç±»å‹è®¾ç½®åˆç†çš„äº§é‡èŒƒå›´
            const ranges = {
                'ç²®é£Ÿ': { min: 100, max: 3000 },
                'è”¬èœ': { min: 50, max: 2000 },
                'æ°´æœ': { min: 30, max: 1500 },
                'æ²¹æ–™': { min: 20, max: 800 },
                'å…¶ä»–': { min: 10, max: 1000 }
            };
            
            // ç‰¹æ®Šçœä»½çš„äº§é‡èŒƒå›´è°ƒæ•´
            const provinceAdjustments = {
                'åŒ—äº¬': { factor: 0.3 }, // ç›´è¾–å¸‚äº§é‡ç›¸å¯¹è¾ƒä½
                'å¤©æ´¥': { factor: 0.3 },
                'ä¸Šæµ·': { factor: 0.3 },
                'é‡åº†': { factor: 0.4 },
                'è¥¿è—': { factor: 0.2 }, // é«˜æµ·æ‹”åœ°åŒºäº§é‡è¾ƒä½
                'é’æµ·': { factor: 0.3 },
                'æ–°ç–†': { factor: 0.5 },
                'å†…è’™å¤': { factor: 0.6 },
                'é»‘é¾™æ±Ÿ': { factor: 1.2 }, // å†œä¸šå¤§çœäº§é‡è¾ƒé«˜
                'å‰æ—': { factor: 1.1 },
                'è¾½å®': { factor: 1.0 },
                'å±±ä¸œ': { factor: 1.3 },
                'æ²³å—': { factor: 1.2 },
                'å››å·': { factor: 1.1 },
                'æ¹–å—': { factor: 1.0 },
                'æ¹–åŒ—': { factor: 1.0 },
                'æ±Ÿè‹': { factor: 1.1 },
                'å®‰å¾½': { factor: 1.0 },
                'æ±Ÿè¥¿': { factor: 0.9 },
                'æµ™æ±Ÿ': { factor: 0.8 },
                'ç¦å»º': { factor: 0.7 },
                'å¹¿ä¸œ': { factor: 0.8 },
                'å¹¿è¥¿': { factor: 0.8 },
                'æµ·å—': { factor: 0.4 },
                'äº‘å—': { factor: 0.7 },
                'è´µå·': { factor: 0.6 },
                'é™•è¥¿': { factor: 0.8 },
                'ç”˜è‚ƒ': { factor: 0.5 },
                'å®å¤': { factor: 0.4 },
                'å±±è¥¿': { factor: 0.7 },
                'æ²³åŒ—': { factor: 1.0 }
            };
            
            const range = ranges[cropType] || ranges['å…¶ä»–'];
            const adjustment = provinceAdjustments[province] || { factor: 1.0 };
            
            const adjustedMin = range.min * adjustment.factor;
            const adjustedMax = range.max * adjustment.factor;
            
            if (output < adjustedMin || output > adjustedMax) {
                const message = `äº§é‡ ${output} å¨ä¸ç¬¦åˆå®é™…æƒ…å†µï¼\n\n` +
                              `å»ºè®®èŒƒå›´ï¼š${adjustedMin.toFixed(1)} - ${adjustedMax.toFixed(1)} å¨\n` +
                              `çœä»½ï¼š${province}\n` +
                              `ä½œç‰©ç±»å‹ï¼š${cropType}`;
                swal({
                    title: "äº§é‡éªŒè¯å¤±è´¥",
                    text: `äº§é‡ ${output} å¨ä¸ç¬¦åˆå®é™…æƒ…å†µï¼\n\nå»ºè®®èŒƒå›´ï¼š${adjustedMin.toFixed(1)} - ${adjustedMax.toFixed(1)} å¨\nçœä»½ï¼š${province}\nä½œç‰©ç±»å‹ï¼š${cropType}`,
                    type: "warning",
                    confirmButtonText: "ç¡®å®š"
                });
                return false;
            }
            
            return true;
        }
        
        // ä¼ æ„Ÿå™¨æ•°æ®éªŒè¯å‡½æ•°
        function validateSensorData(sensorData) {
            const errors = [];
            
            // æ¸©åº¦éªŒè¯ (-50åˆ°100â„ƒ)
            if (sensorData.temp !== null && (sensorData.temp < -50 || sensorData.temp > 100)) {
                errors.push(`æ¸©åº¦ ${sensorData.temp}â„ƒ è¶…å‡ºåˆç†èŒƒå›´ (-50åˆ°100â„ƒ)`);
            }
            
            // æ¹¿åº¦éªŒè¯ (0åˆ°100%)
            if (sensorData.humidity !== null && (sensorData.humidity < 0 || sensorData.humidity > 100)) {
                errors.push(`æ¹¿åº¦ ${sensorData.humidity}% è¶…å‡ºåˆç†èŒƒå›´ (0åˆ°100%)`);
            }
            
            // å…‰ç…§éªŒè¯ (0åˆ°10000lux)
            if (sensorData.sunlight !== null && (sensorData.sunlight < 0 || sensorData.sunlight > 10000)) {
                errors.push(`å…‰ç…§ ${sensorData.sunlight}lux è¶…å‡ºåˆç†èŒƒå›´ (0åˆ°10000lux)`);
            }
            
            // åœŸå£¤æ¹¿åº¦éªŒè¯ (0åˆ°100%)
            if (sensorData.soil1 !== null && (sensorData.soil1 < 0 || sensorData.soil1 > 100)) {
                errors.push(`åœŸå£¤1å±‚æ¹¿åº¦ ${sensorData.soil1}% è¶…å‡ºåˆç†èŒƒå›´ (0åˆ°100%)`);
            }
            if (sensorData.soil2 !== null && (sensorData.soil2 < 0 || sensorData.soil2 > 100)) {
                errors.push(`åœŸå£¤2å±‚æ¹¿åº¦ ${sensorData.soil2}% è¶…å‡ºåˆç†èŒƒå›´ (0åˆ°100%)`);
            }
            if (sensorData.soil3 !== null && (sensorData.soil3 < 0 || sensorData.soil3 > 100)) {
                errors.push(`åœŸå£¤3å±‚æ¹¿åº¦ ${sensorData.soil3}% è¶…å‡ºåˆç†èŒƒå›´ (0åˆ°100%)`);
            }
            
            // åœŸå£¤æ¹¿åº¦å±‚æ¬¡å…³ç³»éªŒè¯
            if (sensorData.soil1 !== null && sensorData.soil2 !== null && sensorData.soil1 < sensorData.soil2) {
                errors.push(`åœŸå£¤1å±‚æ¹¿åº¦(${sensorData.soil1}%)åº”å¤§äºåœŸå£¤2å±‚æ¹¿åº¦(${sensorData.soil2}%)`);
            }
            if (sensorData.soil2 !== null && sensorData.soil3 !== null && sensorData.soil2 < sensorData.soil3) {
                errors.push(`åœŸå£¤2å±‚æ¹¿åº¦(${sensorData.soil2}%)åº”å¤§äºåœŸå£¤3å±‚æ¹¿åº¦(${sensorData.soil3}%)`);
            }
            
            // æ¸©æ¹¿åº¦å…³ç³»éªŒè¯
            if (sensorData.temp !== null && sensorData.humidity !== null) {
                if (sensorData.temp > 35 && sensorData.humidity > 80) {
                    errors.push(`é«˜æ¸©é«˜æ¹¿ç»„åˆä¸åˆç†ï¼šæ¸©åº¦${sensorData.temp}â„ƒï¼Œæ¹¿åº¦${sensorData.humidity}%`);
                }
                if (sensorData.temp < 0 && sensorData.humidity > 90) {
                    errors.push(`ä½æ¸©é«˜æ¹¿ç»„åˆä¸åˆç†ï¼šæ¸©åº¦${sensorData.temp}â„ƒï¼Œæ¹¿åº¦${sensorData.humidity}%`);
                }
            }
            
            if (errors.length > 0) {
                swal({
                    title: "ä¼ æ„Ÿå™¨æ•°æ®éªŒè¯å¤±è´¥",
                    text: errors.join('\n'),
                    type: "warning",
                    confirmButtonText: "ç¡®å®š"
                });
                return false;
            }
            
            return true;
        }
        
        // ä»·æ ¼é”€é‡æ•°æ®éªŒè¯å‡½æ•°
        function validateProductData(productData) {
            const errors = [];
            
            // ä»·æ ¼éªŒè¯ (0.1åˆ°20å…ƒ/æ–¤)
            if (productData.price < 0.1 || productData.price > 20) {
                errors.push(`ä»·æ ¼ ${productData.price} å…ƒ/æ–¤ è¶…å‡ºåˆç†èŒƒå›´ (0.1åˆ°20å…ƒ/æ–¤)`);
            }
            
            // é”€é‡éªŒè¯ (1åˆ°5000å¨)
            if (productData.sales < 1 || productData.sales > 5000) {
                errors.push(`é”€é‡ ${productData.sales} å¨ è¶…å‡ºåˆç†èŒƒå›´ (1åˆ°5000å¨)`);
            }
            
            // äº§é‡éªŒè¯ (1åˆ°5000å¨)
            if (productData.yield < 1 || productData.yield > 5000) {
                errors.push(`äº§é‡ ${productData.yield} å¨ è¶…å‡ºåˆç†èŒƒå›´ (1åˆ°5000å¨)`);
            }
            
            // æ”¶æˆå¤©æ•°éªŒè¯ (30åˆ°300å¤©)
            if (productData.harvestDays < 30 || productData.harvestDays > 300) {
                errors.push(`æ”¶æˆå¤©æ•° ${productData.harvestDays} å¤© è¶…å‡ºåˆç†èŒƒå›´ (30åˆ°300å¤©)`);
            }
            
            // äº§é‡åº”å¤§äºç­‰äºé”€é‡
            if (productData.yield < productData.sales) {
                errors.push(`äº§é‡(${productData.yield}å¨)åº”å¤§äºç­‰äºé”€é‡(${productData.sales}å¨)`);
            }
            
            // æ ¹æ®å…·ä½“å†œäº§å“éªŒè¯æ”¶æˆå¤©æ•°
            const productDays = {
                'æ°´ç¨»': { min: 110, max: 140 },
                'å°éº¦': { min: 100, max: 130 },
                'ç‰ç±³': { min: 90, max: 120 },
                'å¤§è±†': { min: 120, max: 150 },
                'è”¬èœ': { min: 30, max: 90 },
                'æ°´æœ': { min: 120, max: 240 }
            };
            
            const range = productDays[productData.name] || { min: 30, max: 300 };
            if (productData.harvestDays < range.min || productData.harvestDays > range.max) {
                errors.push(`${productData.name}çš„æ”¶æˆå¤©æ•°åº”åœ¨${range.min}-${range.max}å¤©èŒƒå›´å†…`);
            }
            
            // æ ¹æ®å†œäº§å“éªŒè¯ä»·æ ¼èŒƒå›´
            const productPrice = {
                'æ°´ç¨»': { min: 1.5, max: 4.0 },
                'å°éº¦': { min: 1.8, max: 4.5 },
                'ç‰ç±³': { min: 1.2, max: 3.5 },
                'å¤§è±†': { min: 2.5, max: 6.0 },
                'è”¬èœ': { min: 0.8, max: 8.0 },
                'æ°´æœ': { min: 2.0, max: 15.0 }
            };
            
            const priceRange = productPrice[productData.name] || { min: 0.1, max: 20 };
            if (productData.price < priceRange.min || productData.price > priceRange.max) {
                errors.push(`${productData.name}çš„ä»·æ ¼åº”åœ¨${priceRange.min}-${priceRange.max}å…ƒ/æ–¤èŒƒå›´å†…`);
            }
            
            // æ ¹æ®å†œäº§å“éªŒè¯äº§é‡é”€é‡èŒƒå›´
            const productVolume = {
                'æ°´ç¨»': { min: 100, max: 3000 },
                'å°éº¦': { min: 100, max: 2500 },
                'ç‰ç±³': { min: 200, max: 4000 },
                'å¤§è±†': { min: 50, max: 1500 },
                'è”¬èœ': { min: 500, max: 5000 },
                'æ°´æœ': { min: 100, max: 2000 }
            };
            
            const volumeRange = productVolume[productData.name] || { min: 1, max: 5000 };
            if (productData.sales < volumeRange.min || productData.sales > volumeRange.max) {
                errors.push(`${productData.name}çš„é”€é‡åº”åœ¨${volumeRange.min}-${volumeRange.max}å¨èŒƒå›´å†…`);
            }
            if (productData.yield < volumeRange.min || productData.yield > volumeRange.max) {
                errors.push(`${productData.name}çš„äº§é‡åº”åœ¨${volumeRange.min}-${volumeRange.max}å¨èŒƒå›´å†…`);
            }
            
            if (errors.length > 0) {
                swal({
                    title: "ä»·æ ¼é”€é‡æ•°æ®éªŒè¯å¤±è´¥",
                    text: errors.join('\n'),
                    type: "warning",
                    confirmButtonText: "ç¡®å®š"
                });
                return false;
            }
            
            return true;
        }
        
        // æ·»åŠ /æ›´æ–°æ•°æ®
        document.getElementById('addForm').onsubmit = function(e) {
            e.preventDefault();
            const name = document.getElementById('province').value.trim();
            const type = document.getElementById('cropType').value;
            const output = parseFloat(document.getElementById('output').value);
            if (!name || isNaN(output) || output <= 0) return;
            
            // éªŒè¯äº§é‡æ˜¯å¦ç¬¦åˆå®é™…æƒ…å†µ
            if (!validateOutput(output, name, type)) {
                return;
            }
            
            if (DB_CONFIG.storageMode === 'database') {
                // æ•°æ®åº“æ¨¡å¼
                const cropData = {
                    name: name,
                    type: type,
                    output: output
                };
                
                DB_API.saveCropData(cropData).then(result => {
                    if (result && result.success) {
                        renderTable();
                        this.reset();
                        swal({
                            title: "æ“ä½œæˆåŠŸ",
                            text: `çœä»½ "${name}" çš„å†œä¸šæ•°æ®å·²æ·»åŠ ï¼`,
                            type: "success",
                            confirmButtonText: "ç¡®å®š"
                        });
                    } else {
                        swal({
                            title: "æ“ä½œå¤±è´¥",
                            text: result?.error || "ä¿å­˜æ•°æ®å¤±è´¥",
                            type: "error",
                            confirmButtonText: "ç¡®å®š"
                        });
                    }
                }).catch(error => {
                    console.error('ä¿å­˜æ•°æ®å¤±è´¥:', error);
                    swal({
                        title: "æ“ä½œå¤±è´¥",
                        text: "æ•°æ®åº“è¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–åˆ‡æ¢åˆ°æœ¬åœ°å­˜å‚¨æ¨¡å¼",
                        type: "error",
                        confirmButtonText: "ç¡®å®š"
                    });
                });
            } else {
                // æœ¬åœ°å­˜å‚¨æ¨¡å¼
                let data = getData();
                const idx = data.findIndex(item => item.name === name);
                if (idx > -1) {
                    data[idx] = {name, type, output};
                } else {
                    data.push({name, type, output});
                }
                saveData(data);
                renderTable();
                this.reset();
                swal({
                    title: "æ“ä½œæˆåŠŸ",
                    text: `çœä»½ "${name}" çš„å†œä¸šæ•°æ®å·²${idx > -1 ? 'æ›´æ–°' : 'æ·»åŠ '}ï¼`,
                    type: "success",
                    confirmButtonText: "ç¡®å®š"
                });
            }
        };
        
        // ä½œç‰©ç±»å‹è¡¨å•æäº¤
        document.getElementById('cropTypeForm').onsubmit = function(e) {
            e.preventDefault();
            const newCropType = document.getElementById('newCropType').value.trim();
            if (!newCropType) return;

            let cropTypes = JSON.parse(localStorage.getItem('agri_crop_types') || '[]');
            if (!cropTypes.includes(newCropType)) {
                cropTypes.push(newCropType);
                localStorage.setItem('agri_crop_types', JSON.stringify(cropTypes));
                renderCropTypeList();
                this.reset();
                swal({
                    title: "æ·»åŠ æˆåŠŸ",
                    text: `ä½œç‰©ç±»å‹ "${newCropType}" å·²æˆåŠŸæ·»åŠ ï¼`,
                    type: "success",
                    confirmButtonText: "ç¡®å®š"
                });
            } else {
                swal({
                    title: "æ·»åŠ å¤±è´¥",
                    text: "è¯¥ä½œç‰©ç±»å‹å·²å­˜åœ¨ï¼",
                    type: "error",
                    confirmButtonText: "ç¡®å®š"
                });
            }
        };

        // æ¸²æŸ“ä½œç‰©ç±»å‹åˆ—è¡¨
        function renderCropTypeList() {
            const cropTypes = JSON.parse(localStorage.getItem('agri_crop_types') || '[]');
            const cropTypeListDiv = document.getElementById('cropTypeList');
            cropTypeListDiv.innerHTML = ''; // Clear previous list
            cropTypes.forEach((type, index) => {
                const div = document.createElement('div');
                div.innerHTML = `
                    <span>${type}</span>
                    <button class="admin-btn" style="margin-left: 8px; padding: 2px 6px; font-size: 0.8rem;" onclick="deleteCropType(${index})">åˆ é™¤</button>
                `;
                cropTypeListDiv.appendChild(div);
            });
            updateCropTypeSelect(); // æ›´æ–°ä¸‹æ‹‰æ¡†é€‰é¡¹
        }
        
        // åˆ é™¤ä½œç‰©ç±»å‹
        window.deleteCropType = function(index) {
            let cropTypes = JSON.parse(localStorage.getItem('agri_crop_types') || '[]');
            const cropTypeName = cropTypes[index];
            
            swal({
                title: "ç¡®è®¤åˆ é™¤",
                text: `ç¡®å®šè¦åˆ é™¤ä½œç‰©ç±»å‹ "${cropTypeName}" å—ï¼Ÿ`,
                type: "warning",
                showCancelButton: true,
                confirmButtonColor: "#DD6B55",
                confirmButtonText: "ç¡®å®šåˆ é™¤",
                cancelButtonText: "å–æ¶ˆ",
                closeOnConfirm: false,
                closeOnCancel: false
            }, function(isConfirm) {
                if (isConfirm) {
                    cropTypes.splice(index, 1);
                    localStorage.setItem('agri_crop_types', JSON.stringify(cropTypes));
                    renderCropTypeList();
                    swal({
                        title: "åˆ é™¤æˆåŠŸ",
                        text: `ä½œç‰©ç±»å‹ "${cropTypeName}" å·²åˆ é™¤ï¼`,
                        type: "success",
                        confirmButtonText: "ç¡®å®š"
                    });
                }
            });
        };
        
        // æ›´æ–°ä½œç‰©ç±»å‹ä¸‹æ‹‰æ¡†
        function updateCropTypeSelect() {
            const cropTypeSelect = document.getElementById('cropType');
            const customTypes = JSON.parse(localStorage.getItem('agri_crop_types') || '[]');
            const defaultTypes = ['ç²®é£Ÿ', 'è”¬èœ', 'æ°´æœ', 'æ²¹æ–™', 'å…¶ä»–'];
            const allTypes = [...defaultTypes, ...customTypes];
            
            // ä¿å­˜å½“å‰é€‰ä¸­çš„å€¼
            const currentValue = cropTypeSelect.value;
            
            // æ¸…ç©ºå¹¶é‡æ–°æ·»åŠ é€‰é¡¹
            cropTypeSelect.innerHTML = '';
            allTypes.forEach(type => {
                const option = document.createElement('option');
                option.value = type;
                option.textContent = type;
                cropTypeSelect.appendChild(option);
            });
            
            // æ¢å¤é€‰ä¸­çš„å€¼
            if (currentValue && allTypes.includes(currentValue)) {
                cropTypeSelect.value = currentValue;
            }
        }
        
        // ä¼ æ„Ÿå™¨è¡¨å•æäº¤
        document.getElementById('sensorForm').onsubmit = function(e) {
            e.preventDefault();
            const selectedDate = document.getElementById('datePicker').value;
            const temp = parseFloat(document.getElementById('temp').value) || null;
            const humidity = parseFloat(document.getElementById('humidity').value) || null;
            const sunlight = parseFloat(document.getElementById('sunlight').value) || null;
            const soil1 = parseFloat(document.getElementById('soil1').value) || null;
            const soil2 = parseFloat(document.getElementById('soil2').value) || null;
            const soil3 = parseFloat(document.getElementById('soil3').value) || null;
            
            const sensorData = {temp, humidity, sunlight, soil1, soil2, soil3};
            
            // éªŒè¯ä¼ æ„Ÿå™¨æ•°æ®
            if (!validateSensorData(sensorData)) {
                return;
            }
            
            if (DB_CONFIG.storageMode === 'database') {
                // æ•°æ®åº“æ¨¡å¼
                DB_API.saveWeatherData(selectedDate, sensorData).then(result => {
                    if (result && result.success) {
                        renderSensorTable();
                        this.reset();
                        swal({
                            title: "æ“ä½œæˆåŠŸ",
                            text: `${selectedDate} çš„ä¼ æ„Ÿå™¨æ•°æ®å·²ä¿å­˜ï¼`,
                            type: "success",
                            confirmButtonText: "ç¡®å®š"
                        });
                    } else {
                        swal({
                            title: "æ“ä½œå¤±è´¥",
                            text: result?.error || "ä¿å­˜æ•°æ®å¤±è´¥",
                            type: "error",
                            confirmButtonText: "ç¡®å®š"
                        });
                    }
                }).catch(error => {
                    console.error('ä¿å­˜ä¼ æ„Ÿå™¨æ•°æ®å¤±è´¥:', error);
                    swal({
                        title: "æ“ä½œå¤±è´¥",
                        text: "æ•°æ®åº“è¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–åˆ‡æ¢åˆ°æœ¬åœ°å­˜å‚¨æ¨¡å¼",
                        type: "error",
                        confirmButtonText: "ç¡®å®š"
                    });
                });
            } else {
                // æœ¬åœ°å­˜å‚¨æ¨¡å¼
                let data = getSensorData();
                data[selectedDate] = sensorData;
                saveSensorData(data);
                renderSensorTable();
                this.reset();
                swal({
                    title: "æ“ä½œæˆåŠŸ",
                    text: `${selectedDate} çš„ä¼ æ„Ÿå™¨æ•°æ®å·²ä¿å­˜ï¼`,
                    type: "success",
                    confirmButtonText: "ç¡®å®š"
                });
            }
        };
        
        // ä»·æ ¼é”€é‡è¡¨å•æäº¤
        document.getElementById('productForm').onsubmit = function(e) {
            e.preventDefault();
            const selectedDate = document.getElementById('datePicker').value;
            const name = document.getElementById('productName').value.trim();
            const price = parseFloat(document.getElementById('price').value);
            const sales = parseFloat(document.getElementById('sales').value);
            const yield = parseFloat(document.getElementById('yield').value);
            const harvestDays = parseInt(document.getElementById('harvestDays').value);
            
            if (!name || isNaN(price) || isNaN(sales) || isNaN(yield) || isNaN(harvestDays) || harvestDays <= 0) return;
            
            const productData = {name, price, sales, yield, harvestDays};
            
            // éªŒè¯ä»·æ ¼é”€é‡æ•°æ®
            if (!validateProductData(productData)) {
                return;
            }
            
            let data = getProductData();
            if (!data[selectedDate]) data[selectedDate] = [];
            
            const idx = data[selectedDate].findIndex(item => item.name === name);
            if (idx > -1) {
                data[selectedDate][idx] = productData;
            } else {
                data[selectedDate].push(productData);
            }
            saveProductData(data);
            renderProductTable();
            this.reset();
            swal({
                title: "æ“ä½œæˆåŠŸ",
                text: `${selectedDate} çš„ "${name}" ä»·æ ¼é”€é‡æ•°æ®å·²${idx > -1 ? 'æ›´æ–°' : 'æ·»åŠ '}ï¼`,
                type: "success",
                confirmButtonText: "ç¡®å®š"
            });
        };
        
        // ç¼–è¾‘è¡Œ
        window.editRow = function(idx) {
            const data = getData();
            const item = data[idx];
            document.getElementById('province').value = item.name;
            document.getElementById('cropType').value = item.type;
            document.getElementById('output').value = item.output;
        };
        
        // ç¼–è¾‘ä¼ æ„Ÿå™¨è¡Œ
        window.editSensorRow = function() {
            const data = getSensorData();
            const selectedDate = document.getElementById('datePicker').value;
            const item = data[selectedDate];
            if (item) {
                document.getElementById('temp').value = item.temp || '';
                document.getElementById('humidity').value = item.humidity || '';
                document.getElementById('sunlight').value = item.sunlight || '';
                document.getElementById('soil1').value = item.soil1 || '';
                document.getElementById('soil2').value = item.soil2 || '';
                document.getElementById('soil3').value = item.soil3 || '';
            }
        };
        
        // ç¼–è¾‘ä»·æ ¼é”€é‡è¡Œ
        window.editProductRow = function(idx) {
            const data = getProductData();
            const selectedDate = document.getElementById('datePicker').value;
            const item = data[selectedDate][idx];
            document.getElementById('productName').value = item.name;
            document.getElementById('price').value = item.price;
            document.getElementById('sales').value = item.sales;
            document.getElementById('yield').value = item.yield;
            document.getElementById('harvestDays').value = item.harvestDays;
        };
        
        // åˆ é™¤è¡Œ
        window.deleteRow = function(idx) {
            if (DB_CONFIG.storageMode === 'database') {
                // æ•°æ®åº“æ¨¡å¼ï¼šidx æ˜¯ä½œç‰©ç±»å‹åç§°
                DB_API.deleteCropData(idx).then(result => {
                    if (result && result.success) {
                        renderTable();
                        swal({
                            title: "åˆ é™¤æˆåŠŸ",
                            text: `ä½œç‰©ç±»å‹ "${idx}" å·²åˆ é™¤ï¼`,
                            type: "success",
                            confirmButtonText: "ç¡®å®š"
                        });
                    } else {
                        swal({
                            title: "åˆ é™¤å¤±è´¥",
                            text: result?.error || "åˆ é™¤æ•°æ®å¤±è´¥",
                            type: "error",
                            confirmButtonText: "ç¡®å®š"
                        });
                    }
                }).catch(error => {
                    console.error('åˆ é™¤æ•°æ®å¤±è´¥:', error);
                    swal({
                        title: "åˆ é™¤å¤±è´¥",
                        text: "æ•°æ®åº“è¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–åˆ‡æ¢åˆ°æœ¬åœ°å­˜å‚¨æ¨¡å¼",
                        type: "error",
                        confirmButtonText: "ç¡®å®š"
                    });
                });
            } else {
                // æœ¬åœ°å­˜å‚¨æ¨¡å¼
                let data = getData();
                data.splice(idx, 1);
                saveData(data);
                renderTable();
            }
        };
        
        // åˆ é™¤ä¼ æ„Ÿå™¨è¡Œ
        window.deleteSensorRow = function() {
            const selectedDate = document.getElementById('datePicker').value;
            
            if (DB_CONFIG.storageMode === 'database') {
                // æ•°æ®åº“æ¨¡å¼
                DB_API.deleteWeatherData(selectedDate).then(result => {
                    if (result && result.success) {
                        renderSensorTable();
                        swal({
                            title: "åˆ é™¤æˆåŠŸ",
                            text: `${selectedDate} çš„ä¼ æ„Ÿå™¨æ•°æ®å·²åˆ é™¤ï¼`,
                            type: "success",
                            confirmButtonText: "ç¡®å®š"
                        });
                    } else {
                        swal({
                            title: "åˆ é™¤å¤±è´¥",
                            text: result?.error || "åˆ é™¤æ•°æ®å¤±è´¥",
                            type: "error",
                            confirmButtonText: "ç¡®å®š"
                        });
                    }
                }).catch(error => {
                    console.error('åˆ é™¤ä¼ æ„Ÿå™¨æ•°æ®å¤±è´¥:', error);
                    swal({
                        title: "åˆ é™¤å¤±è´¥",
                        text: "æ•°æ®åº“è¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–åˆ‡æ¢åˆ°æœ¬åœ°å­˜å‚¨æ¨¡å¼",
                        type: "error",
                        confirmButtonText: "ç¡®å®š"
                    });
                });
            } else {
                // æœ¬åœ°å­˜å‚¨æ¨¡å¼
                let data = getSensorData();
                delete data[selectedDate];
                saveSensorData(data);
                renderSensorTable();
            }
        };
        
        // åˆ é™¤ä»·æ ¼é”€é‡è¡Œ
        window.deleteProductRow = function(idx) {
            let data = getProductData();
            const selectedDate = document.getElementById('datePicker').value;
            data[selectedDate].splice(idx, 1);
            if (data[selectedDate].length === 0) {
                delete data[selectedDate];
            }
            saveProductData(data);
            renderProductTable();
        };
        
        // æ ‡ç­¾é¡µåˆ‡æ¢
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.onclick = function() {
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                const tab = this.getAttribute('data-tab');
                document.querySelectorAll('.tab-content').forEach(tc => tc.style.display = 'none');
                document.getElementById('tab-' + tab).style.display = '';
                
                // æ ¹æ®æ ‡ç­¾é¡µé‡æ–°æ¸²æŸ“å¯¹åº”è¡¨æ ¼
                if (tab === 'sensor') {
                    renderSensorTable();
                } else if (tab === 'product') {
                    renderProductTable();
                }
            };
        });
        
        // æ—¥æœŸé€‰æ‹©å™¨å˜åŒ–æ—¶é‡æ–°æ¸²æŸ“è¡¨æ ¼
        const dateInput = document.getElementById('datePicker');
        dateInput.onchange = function() {
            renderSensorTable();
            renderProductTable();
        };
        
        // æ—¥æœŸé€‰æ‹©å™¨åˆå§‹åŒ–ä¸ºä»Šå¤©
        function getTodayStr() {
            const d = new Date();
            return d.toISOString().slice(0,10);
        }
        dateInput.value = getTodayStr();
        
        // å®æ—¶æ—¶é—´æ˜¾ç¤º
        function updateTime() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            document.getElementById('showtime').textContent = 
                `${year}å¹´${month}æœˆ${day}æ—¥ ${hours}æ—¶${minutes}åˆ†${seconds}ç§’`;
        }
        setInterval(updateTime, 1000); // æ¯ç§’æ›´æ–°ä¸€æ¬¡
        updateTime(); // é¡µé¢åŠ è½½æ—¶ç«‹å³æ›´æ–°ä¸€æ¬¡
        
        // æ•°æ®åº“æ¥å£é…ç½®
        const DB_CONFIG = {
            // å­˜å‚¨æ¨¡å¼ï¼š'localStorage' æˆ– 'database'
            storageMode: 'localStorage',
            
            // æ•°æ®åº“è¿æ¥é…ç½®
            database: {
                type: 'mysql',
                host: 'localhost',
                port: 3306,
                name: 'myollama',
                user: 'root',
                password: ''
            },
             
            // æ•°æ®åº“APIæ¥å£é…ç½®
            apiBaseUrl: 'http://localhost:3000/api',
            apiEndpoints: {
                // ä½œç‰©æ•°æ® (å¯¹åº”cropè¡¨)
                crop: '/crop',
                // å¤©æ°”æ•°æ® (å¯¹åº”weatherè¡¨)
                weather: '/weather'
            },
            
            // APIè¯·æ±‚é…ç½®
            requestConfig: {
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer your-token-here'
                }
            }
        };
        
        // åˆå§‹åŒ–
        function init() {
            loadDbConfig(); // åŠ è½½æ•°æ®åº“é…ç½®
            updateStorageModeDisplay(); // æ›´æ–°å­˜å‚¨æ¨¡å¼æ˜¾ç¤º
            renderTable();
            renderSensorTable();
            renderProductTable();
            renderCropTypeList();
            updateCropTypeSelect();
        }
        
        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        init();
        
        // å†œäº§å“ç±»å‹è‡ªåŠ¨åŒ¹é…
        const productTypeMap = {
            'æ°´ç¨»': 'ç²®é£Ÿ',
            'å°éº¦': 'ç²®é£Ÿ', 
            'ç‰ç±³': 'ç²®é£Ÿ',
            'å¤§è±†': 'æ²¹æ–™',
            'è”¬èœ': 'è”¬èœ',
            'æ°´æœ': 'æ°´æœ'
        };
        
        // å†œäº§å“é€‰æ‹©æ—¶è‡ªåŠ¨è®¾ç½®ç±»å‹
        document.getElementById('productName').onchange = function() {
            const selectedProduct = this.value;
            const productTypeSelect = document.getElementById('cropType');
            if (selectedProduct && productTypeMap[selectedProduct]) {
                productTypeSelect.value = productTypeMap[selectedProduct];
            }
        };
        
        // æ•°æ®åº“è¿æ¥é…ç½®å‡½æ•°
        function loadDbConfig() {
            const config = localStorage.getItem('db_config');
            if (config) {
                const savedConfig = JSON.parse(config);
                DB_CONFIG.database = { ...DB_CONFIG.database, ...savedConfig };
                
                // æ›´æ–°è¡¨å•æ˜¾ç¤º
                document.getElementById('dbType').value = DB_CONFIG.database.type;
                document.getElementById('dbHost').value = DB_CONFIG.database.host;
                document.getElementById('dbPort').value = DB_CONFIG.database.port;
                document.getElementById('dbName').value = DB_CONFIG.database.name;
                document.getElementById('dbUser').value = DB_CONFIG.database.user;
                document.getElementById('dbPassword').value = DB_CONFIG.database.password;
            }
            
            // æ›´æ–°å­˜å‚¨æ¨¡å¼æ˜¾ç¤º
            updateStorageModeDisplay();
        }
        
        function saveDbConfig() {
            const config = {
                type: document.getElementById('dbType').value,
                host: document.getElementById('dbHost').value,
                port: parseInt(document.getElementById('dbPort').value),
                name: document.getElementById('dbName').value,
                user: document.getElementById('dbUser').value,
                password: document.getElementById('dbPassword').value
            };
            
            DB_CONFIG.database = config;
            localStorage.setItem('db_config', JSON.stringify(config));
            
            swal({
                title: "é…ç½®ä¿å­˜æˆåŠŸ",
                text: "æ•°æ®åº“è¿æ¥é…ç½®å·²ä¿å­˜ï¼",
                type: "success",
                confirmButtonText: "ç¡®å®š"
            });
        }
        
        async function testDbConnection() {
            const statusElement = document.getElementById('connectionStatus');
            statusElement.textContent = 'æµ‹è¯•è¿æ¥ä¸­...';
            statusElement.style.color = '#f7b500';
            
            try {
                // è·å–å½“å‰é…ç½®
                const config = {
                    type: document.getElementById('dbType').value,
                    host: document.getElementById('dbHost').value,
                    port: parseInt(document.getElementById('dbPort').value),
                    name: document.getElementById('dbName').value,
                    user: document.getElementById('dbUser').value,
                    password: document.getElementById('dbPassword').value
                };
                
                // æ ¹æ®æ•°æ®åº“ç±»å‹é€‰æ‹©ä¸åŒçš„æµ‹è¯•API
                let testUrl = 'http://localhost:3000/api/db/test-mysql';
                
                const testResult = await fetch(testUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(config)
                });
                
                if (testResult.ok) {
                    const result = await testResult.json();
                    statusElement.textContent = 'è¿æ¥æˆåŠŸ âœ“';
                    statusElement.style.color = '#52c41a';
                    swal({
                        title: "è¿æ¥æˆåŠŸ",
                        text: `æ•°æ®åº“è¿æ¥æµ‹è¯•é€šè¿‡ï¼\næ•°æ®åº“ç‰ˆæœ¬: ${result.version || 'æœªçŸ¥'}\nè¿æ¥æ—¶é—´: ${result.connectionTime || 'æœªçŸ¥'}ms`,
                        type: "success",
                        confirmButtonText: "ç¡®å®š"
                    });
                } else {
                    const errorData = await testResult.json();
                    throw new Error(errorData.message || 'è¿æ¥å¤±è´¥');
                }
            } catch (error) {
                statusElement.textContent = 'è¿æ¥å¤±è´¥ âœ—';
                statusElement.style.color = '#ff4d4f';
                swal({
                    title: "è¿æ¥å¤±è´¥",
                    text: `é”™è¯¯ä¿¡æ¯: ${error.message}\n\nè¯·æ£€æŸ¥:\n1. æ•°æ®åº“æœåŠ¡æ˜¯å¦å¯åŠ¨\n2. è¿æ¥å‚æ•°æ˜¯å¦æ­£ç¡®\n3. ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸`,
                    type: "error",
                    confirmButtonText: "ç¡®å®š"
                });
            }
        }
        
        function updateStorageModeDisplay() {
            const displayElement = document.getElementById('storageModeDisplay');
            const currentMode = DB_CONFIG.storageMode;
            
            displayElement.textContent = currentMode === 'localStorage' ? 'æœ¬åœ°å­˜å‚¨' : 'æ•°æ®åº“';
            displayElement.className = 'mode-value ' + currentMode;
        }
        
        function toggleStorageMode() {
            const currentMode = DB_CONFIG.storageMode;
            const newMode = currentMode === 'localStorage' ? 'database' : 'localStorage';
            DB_CONFIG.storageMode = newMode;
            
            // æ›´æ–°æ˜¾ç¤º
            updateStorageModeDisplay();
            
            swal({
                title: "å­˜å‚¨æ¨¡å¼åˆ‡æ¢",
                text: `å·²åˆ‡æ¢åˆ°${newMode === 'database' ? 'æ•°æ®åº“' : 'æœ¬åœ°å­˜å‚¨'}æ¨¡å¼`,
                type: "info",
                confirmButtonText: "ç¡®å®š"
            });
            
            // é‡æ–°åŠ è½½æ•°æ®
            renderTable();
            renderSensorTable();
            renderProductTable();
        }
        
        // æ•°æ®åº“APIæ¥å£å‡½æ•°
        const DB_API = {
            // é€šç”¨APIè¯·æ±‚å‡½æ•°
            async request(endpoint, method = 'GET', data = null) {
                if (DB_CONFIG.storageMode === 'localStorage') {
                    return null;
                }
                
                try {
                    const url = DB_CONFIG.apiBaseUrl + endpoint;
                    const options = {
                        method: method,
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        ...(data && { body: JSON.stringify(data) })
                    };
                    
                    const response = await fetch(url, options);
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || `APIè¯·æ±‚å¤±è´¥: ${response.status}`);
                    }
                    return await response.json();
                } catch (error) {
                    console.error('APIè¯·æ±‚é”™è¯¯:', error);
                    swal({
                        title: "æ•°æ®åº“è¿æ¥å¤±è´¥",
                        text: `é”™è¯¯ä¿¡æ¯: ${error.message}\næ­£åœ¨ä½¿ç”¨æœ¬åœ°å­˜å‚¨æ¨¡å¼`,
                        type: "warning",
                        confirmButtonText: "ç¡®å®š"
                    });
                    return null;
                }
            },
            
            // ä½œç‰©æ•°æ®API (å¯¹åº”cropè¡¨)
            async getCropData() {
                return await this.request('/crop');
            },
            
            async saveCropData(data) {
                // è½¬æ¢ä¸ºåç«¯æœŸæœ›çš„æ ¼å¼
                const cropData = {
                    type: data.name, // çœä»½åä½œä¸ºä½œç‰©ç±»å‹
                    day: data.harvestDays || 120, // é»˜è®¤æ”¶æˆå¤©æ•°
                    output: data.output,
                    price: data.price || 0
                };
                return await this.request('/crop', 'POST', cropData);
            },
            
            async updateCropData(type, data) {
                const cropData = {
                    day: data.harvestDays || 120,
                    output: data.output,
                    price: data.price || 0
                };
                return await this.request(`/crop/${encodeURIComponent(type)}`, 'PUT', cropData);
            },
            
            async deleteCropData(type) {
                return await this.request(`/crop/${encodeURIComponent(type)}`, 'DELETE');
            },
            
            // å¤©æ°”æ•°æ®API (å¯¹åº”weatherè¡¨)
            async getWeatherData(date = null) {
                const endpoint = date ? `/weather?date=${date}` : '/weather';
                return await this.request(endpoint);
            },
            
            async saveWeatherData(date, data) {
                const weatherData = {
                    temp: data.temp,
                    wet: data.humidity,
                    sun: data.sunlight,
                    tsoil1: data.soil1,
                    tsoil2: data.soil2,
                    tsoil3: data.soil3
                };
                return await this.request('/weather', 'POST', { date, data: weatherData });
            },
            
            async updateWeatherData(date, data) {
                const weatherData = {
                    temp: data.temp,
                    wet: data.humidity,
                    sun: data.sunlight,
                    tsoil1: data.soil1,
                    tsoil2: data.soil2,
                    tsoil3: data.soil3
                };
                return await this.request(`/weather/${date}`, 'PUT', weatherData);
            },
            
            async deleteWeatherData(date) {
                return await this.request(`/weather/${date}`, 'DELETE');
            }
        };
        
    </script>
</body>
</html>