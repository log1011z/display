<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>AgriSage</title>
    <!-- å¼•å…¥ ECharts -->
    <script src="static/js/echarts.min.js"></script>
    <!-- å¼•å…¥ä¸­å›½åœ°å›¾æ•°æ® -->
    <script src="static/js/china.js"></script>
    <link rel="stylesheet" href="static/css/styles.css" />
  </head>
  <style>
    body {
      background: url("static/img/bg7.jpg") no-repeat center center fixed;
      background-size: cover;
      background-color: #39d87e; /* å¤‡ç”¨èƒŒæ™¯è‰² */
    }
  </style>
  <body>
    <!-- é€€å‡ºæŒ‰é’® -->
    <a href="/logout" id="logout-button" class="logout-btn" title="é€€å‡ºç™»å½•">
      <svg viewBox="0 0 1024 1024" width="24" height="24" fill="#fff">
        <path
          d="M946.076751 472.579151c0 14.176886-5.739126 27.002092-15.030745 36.318917l0 0-102.596923 102.549662 0 0c-9.294769 9.316825-22.119975 15.027594-36.273231 15.027594-28.325415 0-51.299249-22.943902-51.299249-51.247262 0-14.180037 5.735975-27.003668 15.030745-36.322068l0 0 15.027594-14.980332-132.655262 0c-28.328566 0-51.299249-22.992738-51.299249-51.348086 0-28.304935 22.969108-51.300825 51.299249-51.300825l132.655262 0-15.027594-14.977182 0 0c-9.294769-9.3184-15.030745-22.143606-15.030745-36.322068 0-28.30336 22.972258-51.299249 51.299249-51.299249 14.153255 0 26.978462 5.761182 36.273231 15.078006l0 0 102.596923 102.549662 0 0C940.337625 445.625895 946.076751 458.451102 946.076751 472.579151zM792.174277 216.131742 689.577354 216.131742l-102.596923 0L361.794954 216.131742l97.662818 58.61376-0.448985 0.701046c14.901563 9.017502 25.371569 24.598055 25.371569 43.23328l0 410.444406 51.299249 0 153.897748 0 102.596923 0c28.331717 0 51.300825 22.943902 51.300825 51.247262 0 28.356923-22.969108 51.351237-51.300825 51.351237L535.679606 831.722732l-51.299249 0 0 51.299249c0 28.304935-22.967532 51.247262-51.299249 51.247262-9.693342 0-18.211446-3.405982-25.951311-8.015557l-0.45056 0.751458L150.182991 773.05856l0.452135-0.701046 0 0c-6.889157-4.159015-12.500677-9.718548-16.782572-16.528935-0.625428-0.953108-1.277637-1.754978-1.829022-2.756923-3.93216-7.213686-6.736345-15.129994-6.736345-23.945846L125.287188 164.78208c0-21.240911 12.924455-39.425575 31.335975-47.241058 6.136123-2.604111 12.874043-4.058191 19.963274-4.058191l0 0 410.395569 0 205.193846 0c28.331717 0 51.300825 22.994314 51.300825 51.299249C843.476677 193.135852 820.507569 216.131742 792.174277 216.131742z"
        />
      </svg>
    </a>

    <div class="left-panel-group">
      <!-- å®æ—¶æ—¶é—´æ˜¾ç¤º -->
      <div class="showtime" id="showtime"></div>
      <!-- ä»Šæ—¥å¤©æ°”æ¨¡å—1 -->
      <div class="weather-panel1">
        <div class="panel-title">å®æ—¶æ¸©ã€æ¹¿åº¦ä¿¡æ¯</div>
        <div class="stats-row">
          <div>
            <div class="desc">ä»Šæ—¥æ¹¿åº¦</div>
            <div class="today-value">
              <div class="value" id="todayHumidity"></div>
              <div class="unit">%</div>
            </div>
          </div>
          <div>
            <div class="desc">ä»Šæ—¥æ¸©åº¦</div>
            <div class="today-value">
              <div class="value" id="todayTemp"></div>
              <div class="unit">â„ƒ</div>
            </div>
          </div>
        </div>
      </div>

      <div class="humidity-panel">
        <div class="panel-title">æ¹¿åº¦ç›‘æµ‹</div>
        <!-- <div class="desc">ä»Šæ—¥æ¹¿åº¦</div>
        <div class="today-value">
          <div class="value" id="todayHumidity">--</div>
          <div class="unit">%</div>
        </div> -->
        <div class="desc">è¿‡å»ä¸ƒå¤©æ¹¿åº¦</div>
        <div class="chart-container" id="humidityChart"></div>
      </div>
      <div class="temp-panel">
        <div class="panel-title">æ¸©åº¦ç›‘æµ‹</div>
        <!-- <div class="desc">ä»Šæ—¥æ¸©åº¦</div>
        <div class="today-value">
          <div class="value" id="todayTemp">--</div>
          <div class="unit">â„ƒ</div>
        </div> -->
        <div class="desc">è¿‡å»ä¸ƒå¤©æ¸©åº¦</div>
        <div class="chart-container" id="tempChart"></div>
      </div>
      <div class="sun-panel">
        <div class="panel-title">å…‰ç…§ç›‘æµ‹</div>
        <!-- <div class="desc">ä»Šæ—¥å…‰ç…§</div>
       <div class="today-value">
         <div class="value" id="todaySun">--</div>
         <div class="unit">lux</div>
       </div> -->
        <div class="desc">è¿‡å»ä¸ƒå¤©å…‰ç…§</div>
        <div class="chart-container" id="sunChart"></div>
      </div>
    </div>

    <div class="right-panel-group">
      <!-- ä»Šæ—¥å¤©æ°”æ¨¡å—2 -->
      <div class="weather-panel2">
        <div class="panel-title">å®æ—¶é£å‘ã€é£é€Ÿä¿¡æ¯</div>
        <div class="stats-row">
          <div>
            <div class="desc">é£é€Ÿ</div>
            <div class="today-value">
              <div class="value" id="todayWindSpeed"></div>
              <div class="unit">km/h</div>
            </div>
          </div>
          <div>
            <div class="desc">é£å‘</div>
            <div class="today-value">
              <div class="value" id="todayWindDirection"></div>
            </div>
          </div>
        </div>
      </div>

      <div class="soil-panel">
        <div class="panel-title">ä¸‰å±‚åœŸå£¤æ¸©åº¦</div>
        <div class="desc">è¿‡å»ä¸ƒå¤©å„å±‚åœŸå£¤æ¸©åº¦</div>
        <div class="chart-container" id="soilChart" style="height: 180px"></div>
      </div>

      <!-- äº§é‡æ¨¡å— -->
      <div class="yield-panel">
        <div class="panel-title">äº§é‡ç»Ÿè®¡</div>
        <div class="desc">å„å†œäº§å“äº§é‡å¯¹æ¯”</div>
        <div
          class="chart-container"
          id="yieldChart"
          style="height: 180px"
        ></div>
      </div>

      <!-- æ”¶æˆå¤©æ•°æ¨¡å— -->
      <div class="harvest-panel">
        <div class="panel-title">æ”¶æˆå¤©æ•°</div>
        <div class="desc">å„å†œä½œç‰©æ”¶æˆå‘¨æœŸ</div>
        <div
          class="chart-container"
          id="harvestChart"
          style="height: 180px"
        ></div>
      </div>
    </div>
    <script src="../static/js/chatv2.js"></script>
    <div id="main" style="width: 900px; height: 600px; margin: 0 auto"></div>

    <!-- å†œäº§å“ä»·æ ¼å’Œé”€é‡å±•ç¤º -->
    <div class="product-stats">
      <div class="stats-title">å†œäº§å“ä»·æ ¼ä¸é”€é‡</div>
      <div class="stats-grid" id="statsGrid">
        <!-- åŠ¨æ€ç”Ÿæˆçš„å†…å®¹ -->
      </div>
    </div>
    <script>
      // åˆå§‹åŒ–EChartså®ä¾‹
      const myChart = echarts.init(document.getElementById("main"));

      // çœä¼šåŸå¸‚æ•°æ®
      const capitalData = [
        { name: "åŒ—äº¬", value: [116.405285, 39.904989] },
        { name: "å¤©æ´¥", value: [117.190182, 39.125596] },
        { name: "çŸ³å®¶åº„", value: [114.502461, 38.045474] },
        { name: "å¤ªåŸ", value: [112.549248, 37.857014] },
        { name: "å‘¼å’Œæµ©ç‰¹", value: [111.670801, 40.818311] },
        { name: "æ²ˆé˜³", value: [123.429096, 41.796767] },
        { name: "é•¿æ˜¥", value: [125.324501, 43.886841] },
        { name: "å“ˆå°”æ»¨", value: [126.642464, 45.756967] },
        { name: "ä¸Šæµ·", value: [121.472644, 31.231706] },
        { name: "å—äº¬", value: [118.767413, 32.041544] },
        { name: "æ­å·", value: [120.153576, 30.287459] },
        { name: "åˆè‚¥", value: [117.283042, 31.86119] },
        { name: "ç¦å·", value: [119.306239, 26.075302] },
        { name: "å—æ˜Œ", value: [115.892151, 28.676493] },
        { name: "æµå—", value: [117.000923, 36.675807] },
        { name: "éƒ‘å·", value: [113.665412, 34.757975] },
        { name: "æ­¦æ±‰", value: [114.298572, 30.584355] },
        { name: "é•¿æ²™", value: [112.982279, 28.19409] },
        { name: "å¹¿å·", value: [113.280637, 23.125178] },
        { name: "å—å®", value: [108.320004, 22.815478] },
        { name: "æµ·å£", value: [110.199891, 20.044001] },
        { name: "é‡åº†", value: [106.504962, 29.533155] },
        { name: "æˆéƒ½", value: [104.065735, 30.659462] },
        { name: "è´µé˜³", value: [106.713478, 26.578343] },
        { name: "æ˜†æ˜", value: [102.712251, 25.040609] },
        { name: "æ‹‰è¨", value: [91.132212, 29.660361] },
        { name: "è¥¿å®‰", value: [108.948024, 34.263161] },
        { name: "å…°å·", value: [103.823557, 36.058039] },
        { name: "è¥¿å®", value: [101.778916, 36.623178] },
        { name: "é“¶å·", value: [106.278179, 38.46637] },
        { name: "ä¹Œé²æœ¨é½", value: [87.617733, 43.792818] },
        { name: "é¦™æ¸¯", value: [114.16546, 22.27534] },
        { name: "æ¾³é—¨", value: [113.54909, 22.198951] },
        { name: "å°åŒ—", value: [121.509062, 25.044332] },
      ];

      // è·å–åœ°å›¾æ•°æ®ï¼ˆæ–°æ¥å£ï¼‰
      const MAP_API = {
        // è·å–åœ°å›¾æ•°æ®
        getMapData: async () => {
          try {
            const response = await fetch("/get_area");
            const data = await response.json();
            return data;
          } catch (error) {
            console.error("è·å–åœ°å›¾æ•°æ®å¤±è´¥:", error);
            // è¿”å›é»˜è®¤æ ¼å¼
            return [
              { name: "åŒ—äº¬", type: "ç²®é£Ÿ", output: 1200 },
              { name: "å¤©æ´¥", type: "è”¬èœ", output: 800 },
              { name: "æ²³åŒ—", type: "ç²®é£Ÿ", output: 1500 },
              { name: "å±±è¥¿", type: "æ²¹æ–™", output: 600 },
              { name: "å†…è’™å¤", type: "ç²®é£Ÿ", output: 900 },
              { name: "è¾½å®", type: "è”¬èœ", output: 1100 },
              { name: "å‰æ—", type: "ç²®é£Ÿ", output: 1300 },
              { name: "é»‘é¾™æ±Ÿ", type: "ç²®é£Ÿ", output: 1400 },
              { name: "ä¸Šæµ·", type: "è”¬èœ", output: 950 },
              { name: "æ±Ÿè‹", type: "ç²®é£Ÿ", output: 1600 },
              { name: "æµ™æ±Ÿ", type: "è”¬èœ", output: 1200 },
              { name: "å®‰å¾½", type: "ç²®é£Ÿ", output: 1100 },
              { name: "ç¦å»º", type: "è”¬èœ", output: 1000 },
              { name: "æ±Ÿè¥¿", type: "ç²®é£Ÿ", output: 900 },
              { name: "å±±ä¸œ", type: "ç²®é£Ÿ", output: 1800 },
              { name: "æ²³å—", type: "ç²®é£Ÿ", output: 1700 },
              { name: "æ¹–åŒ—", type: "è”¬èœ", output: 1300 },
              { name: "æ¹–å—", type: "ç²®é£Ÿ", output: 1000 },
              { name: "å¹¿ä¸œ", type: "è”¬èœ", output: 1500 },
              { name: "å¹¿è¥¿", type: "è”¬èœ", output: 1200 },
              { name: "æµ·å—", type: "è”¬èœ", output: 800 },
              { name: "é‡åº†", type: "è”¬èœ", output: 1100 },
              { name: "å››å·", type: "ç²®é£Ÿ", output: 1400 },
              { name: "è´µå·", type: "ç²®é£Ÿ", output: 800 },
              { name: "äº‘å—", type: "è”¬èœ", output: 1000 },
              { name: "è¥¿è—", type: "ç²®é£Ÿ", output: 300 },
              { name: "é™•è¥¿", type: "ç²®é£Ÿ", output: 900 },
              { name: "ç”˜è‚ƒ", type: "ç²®é£Ÿ", output: 600 },
              { name: "é’æµ·", type: "ç²®é£Ÿ", output: 400 },
              { name: "å®å¤", type: "ç²®é£Ÿ", output: 500 },
              { name: "æ–°ç–†", type: "ç²®é£Ÿ", output: 700 },
              { name: "é¦™æ¸¯", type: "è”¬èœ", output: 200 },
              { name: "æ¾³é—¨", type: "è”¬èœ", output: 150 },
              { name: "å°æ¹¾", type: "è”¬èœ", output: 600 },
            ];
          }
        },
      };

      // åˆå§‹åŒ–åœ°å›¾æ•°æ®
      let provinceData = [];

      // è·å–åœ°å›¾æ•°æ®
      const loadMapData = async () => {
        try {
          const rawData = await MAP_API.getMapData();
          // è®© value å­—æ®µç­‰äº outputï¼ˆäº§é‡ï¼‰
          const provinceData = rawData.map((item) => ({
            ...item,
            value: item.output,
          }));
          // è®¡ç®—äº§é‡çš„æœ€å°å€¼å’Œæœ€å¤§å€¼
          const values = provinceData.map((item) => item.value);
          const minValue = Math.min(...values);
          const maxValue = Math.max(...values);
          // æ›´æ–°åœ°å›¾é…ç½®
          const option = {
            // æ ‡é¢˜é…ç½®
            title: {
              text: "ğŸŒ¾ AgriSage ğŸŒ¾",
              left: "center",
              top: "2%",
              textStyle: {
                color: "#2d5016",
                fontSize: 36,
                fontWeight: "bold",
                textShadow: "2px 2px 4px rgba(0,0,0,0.3)",
                fontFamily: "Arial, sans-serif",
              },
              backgroundColor: {
                type: "linear",
                x: 0,
                y: 0,
                x2: 1,
                y2: 0,
                colorStops: [
                  { offset: 0, color: "rgba(144, 238, 144, 0.8)" },
                  { offset: 0.5, color: "rgba(34, 139, 34, 0.8)" },
                  { offset: 1, color: "rgba(144, 238, 144, 0.8)" },
                ],
              },
              borderRadius: 15,
              padding: [10, 20],
              borderColor: "#228b22",
              borderWidth: 2,
              shadowColor: "rgba(0, 0, 0, 0.3)",
              shadowBlur: 10,
              shadowOffsetX: 2,
              shadowOffsetY: 2,
            },

            // æç¤ºæ¡†é…ç½®
            tooltip: {
              trigger: "item",
              formatter: function (params) {
                if (
                  params.data &&
                  params.data.value &&
                  Array.isArray(params.data.value)
                ) {
                  // çœä¼šåŸå¸‚çš„æç¤º
                  return (
                    params.name +
                    "<br>åæ ‡ï¼š(" +
                    params.data.value[0].toFixed(2) +
                    ", " +
                    params.data.value[1].toFixed(2) +
                    ")"
                  );
                } else {
                  // çœä»½çš„æç¤º - æ˜¾ç¤ºçœä»½ã€ç§ç±»ã€äº§é‡
                  const data = params.data;
                  if (data && data.type && data.output) {
                    return (
                      params.name +
                      "<br>" +
                      "ç§ç±»ï¼š" +
                      data.type +
                      "<br>" +
                      "äº§é‡ï¼š" +
                      data.output +
                      "å¨"
                    );
                  } else {
                    return params.name + "<br>æ•°å€¼ï¼š" + (params.value || 0);
                  }
                }
              },
            },

            // è§†è§‰æ˜ å°„é…ç½®
            visualMap: {
              min: minValue,
              max: maxValue,
              text: ["é«˜äº§", "ä½äº§"],
              realtime: false,
              calculable: true,
              inRange: {
                color: ["#e8f5e8", "#90ee90", "#32cd32", "#228b22", "#006400"],
              },
              left: "5%",
              top: "50%",
            },

            // åœ°å›¾ç³»åˆ—é…ç½®
            series: [
              {
                name: "çœä»½æ•°æ®",
                type: "map",
                map: "china",
                roam: false,
                scaleLimit: {
                  min: 1,
                  max: 3,
                },
                label: {
                  show: true,
                  color: "#333",
                  fontWeight: "bold",
                  fontSize: 15,
                },
                itemStyle: {
                  areaColor: "#e0f3f8",
                  borderColor: "#000000",
                  borderWidth: 2,
                },
                emphasis: {
                  label: {
                    color: "#fff",
                  },
                  itemStyle: {
                    areaColor: "#1a5f1a",
                  },
                },
                data: provinceData,
              },
              {
                name: "çœä¼šåŸå¸‚",
                type: "scatter",
                coordinateSystem: "geo",
                symbol: "pin",
                symbolSize: 30,
                label: {
                  show: true,
                  formatter: "{b}",
                  position: "right",
                  fontSize: 10,
                },
                itemStyle: {
                  color: "#f00",
                },
                emphasis: {
                  label: {
                    show: true,
                  },
                },
                data: capitalData,
              },
            ],
          };
          myChart.setOption(option);
        } catch (error) {
          console.error("åŠ è½½åœ°å›¾æ•°æ®å¤±è´¥:", error);
        }
      };

      // åŠ è½½åœ°å›¾æ•°æ®å¹¶æ˜¾ç¤ºå›¾è¡¨
      loadMapData();

      // è·å–ä¼ æ„Ÿå™¨æ•°æ®ï¼ˆæ–°æ¥å£ï¼‰
      const HUMIDITY_API = {
        // è·å–å…¨éƒ¨ä¼ æ„Ÿå™¨æ•°æ®
        getSensorData: async () => {
          try {
            const response = await fetch("/get_weather");
            const data = await response.json();
            return data;
          } catch (error) {
            console.error("è·å–ä¼ æ„Ÿå™¨æ•°æ®å¤±è´¥:", error);
            // è¿”å›é»˜è®¤æ ¼å¼
            return {
              date: [
                "12-01",
                "12-02",
                "12-03",
                "12-04",
                "12-05",
                "12-06",
                "12-07",
              ],
              wet: [65, 72, 68, 75, 70, 73, 68],
              temp: [18, 25, 33, 28, 17, 10, 25],
              sun: [300, 400, 200, 359, 286, 120, 130],
              tol1: [],
              tol2: [],
              tol3: [],
            };
          }
        },
      };

      // è·å–äº§é‡æ•°æ®ï¼ˆæ–°æ¥å£ï¼‰
      const YIELD_API = {
        // è·å–äº§é‡æ•°æ®
        getYieldData: async () => {
          try {
            const response = await fetch("/get_crop");
            const data = await response.json();
            return data;
          } catch (error) {
            console.error("è·å–äº§é‡æ•°æ®å¤±è´¥:", error);
            // è¿”å›é»˜è®¤æ ¼å¼
            return {
              type: ["æ°´ç¨»", "å°éº¦", "ç‰ç±³", "å¤§è±†", "è”¬èœ", "æ°´æœ"],
              output: [1200, 800, 1500, 600, 2000, 900],
              price: [2.5, 2.8, 2.2, 3.0, 1.5, 4.0],
              xiaoliang: [1200, 800, 1500, 600, 2000, 900],
              day: [50, 60, 70, 40, 45, 55],
              grown: [20, 30, 50, 10, 15, 25],
            };
          }
        },
      };

      // è·å–ä»Šæ—¥å¤©æ°”æ•°æ®ï¼ˆæ–°æ¥å£ï¼‰
      const WEATHER_API = {
        // è·å–å¤©æ°”æ•°æ®
        getWeatherData: async () => {
          try {
            const response = await fetch("/get_temp");
            const data = await response.json();
            return data;
          } catch (error) {
            console.error("è·å–å¤©æ°”æ•°æ®å¤±è´¥:", error);
            // è¿”å›é»˜è®¤æ ¼å¼
            return {
              now: {
                temperature: 25,
                humidity: 65,
                windSpeed: 10,
                windDirection: "å—é£",
              },
              forecast: [],
            };
          }
        },

        // æ›´æ–°å¤©æ°”ä¿¡æ¯æ˜¾ç¤º
        updatetodayWeatherDisplay: async () => {
          const data = await WEATHER_API.getWeatherData();
          const now = data?.data?.now || {};
          document.getElementById("todayTemp").textContent = now.temperature;
          document.getElementById("todayHumidity").textContent = now.humidity;
          document.getElementById("todayWindSpeed").textContent = now.windSpeed;
          document.getElementById("todayWindDirection").textContent =
            now.windDirection;
        },
      };

      // åˆå§‹åŒ–æ—¶è°ƒç”¨æ›´æ–°å¤©æ°”æ˜¾ç¤º
      WEATHER_API.updatetodayWeatherDisplay();

      //æ¹¿åº¦æ¨¡å—
      // åˆå§‹åŒ–æ¹¿åº¦æŠ˜çº¿å›¾
      const humidityChart = echarts.init(
        document.getElementById("humidityChart")
      );

      // è®¡ç®—è¿‡å»ä¸ƒå¤©å€¼æ•°ç»„
      function getSevenDayAverages(arr) {
        const result = [];
        for (let i = 0; i < arr.length; i++) {
          const start = Math.max(0, i - 6);
          const slice = arr.slice(start, i + 1);
          const avg = slice.reduce((a, b) => a + b, 0) / slice.length;
          result.push(Number(avg.toFixed(2)));
        }
        // åªå–æœ€å7å¤©
        return result.slice(-7);
      }

      // æ›´æ–°ä»Šæ—¥æ¹¿åº¦æ˜¾ç¤º
      // const updateTodayHumidity = async () => {
      //     const data = await HUMIDITY_API.getSensorData();
      //     const todayHumidity = data.wet && data.wet.length > 0 ? data.wet[data.wet.length - 1] : '--';
      //     document.getElementById('todayHumidity').textContent = todayHumidity;
      // };

      // æ›´æ–°æ¹¿åº¦æŠ˜çº¿å›¾ï¼ˆä¸ƒå¤©ï¼‰
      const updateHumidityChart = async () => {
        const data = await HUMIDITY_API.getSensorData();
        const len = data.date.length;
        const dates = len >= 7 ? data.date.slice(len - 7) : data.date;
        const Wets = data.wet;

        const humidityOption = {
          title: { text: "", left: "center" },
          tooltip: { trigger: "axis", formatter: "{b}: {c}%" },
          xAxis: { type: "category", data: dates, axisLabel: { fontSize: 10 } },
          yAxis: {
            type: "value",
            min: 0,
            max: 100,
            axisLabel: { formatter: "{value}%", fontSize: 10 },
          },
          series: [
            {
              data: Wets,
              type: "line",
              smooth: true,
              lineStyle: { color: "#1890ff", width: 3 },
              itemStyle: { color: "#1890ff" },
              areaStyle: {
                color: {
                  type: "linear",
                  x: 0,
                  y: 0,
                  x2: 0,
                  y2: 1,
                  colorStops: [
                    { offset: 0, color: "rgba(24, 144, 255, 0.3)" },
                    { offset: 1, color: "rgba(24, 144, 255, 0.1)" },
                  ],
                },
              },
            },
          ],
          grid: { left: "13%", right: "10%", top: "20%", bottom: "15%" },
        };
        humidityChart.setOption(humidityOption);
      };

      //æ¸©åº¦æ¨¡å—
      // åˆå§‹åŒ–æ¸©åº¦æŠ˜çº¿å›¾
      const tempChart = echarts.init(document.getElementById("tempChart"));

      // æ›´æ–°ä»Šæ—¥æ¸©åº¦æ˜¾ç¤º
      // const updateTodayTemp = async () => {
      //     const data = await HUMIDITY_API.getSensorData();
      //     let todayTemp = '--';
      //     if (data.temp && data.temp.length > 0 && typeof data.temp[data.temp.length - 1] === 'number') {
      //         todayTemp = data.temp[data.temp.length - 1];
      //     } else {
      //         todayTemp = 27; // è‡ªå®šä¹‰é»˜è®¤å€¼
      //     }
      //     document.getElementById('todayTemp').textContent = todayTemp;
      // };

      // æ›´æ–°æ¸©åº¦æŠ˜çº¿å›¾ï¼ˆä¸ƒå¤©ï¼‰
      const updateTempChart = async () => {
        const data = await HUMIDITY_API.getSensorData();
        let Temps = [];
        let dates = [];
        if (
          data.temp &&
          data.temp.length > 0 &&
          data.date &&
          data.date.length > 0
        ) {
          const len = data.date.length;
          dates = len >= 7 ? data.date.slice(len - 7) : data.date;
          Temps = data.temp;
        } else {
          // è‡ªå®šä¹‰é»˜è®¤å€¼
          dates = [
            "12-01",
            "12-02",
            "12-03",
            "12-04",
            "12-05",
            "12-06",
            "12-07",
          ];
          Temps = [18, 25, 33, 28, 17, 10, 25];
        }

        const tempOption = {
          title: { text: "", left: "center" },
          tooltip: { trigger: "axis", formatter: "{b}: {c}â„ƒ" },
          xAxis: { type: "category", data: dates, axisLabel: { fontSize: 10 } },
          yAxis: {
            type: "value",
            min: 0,
            max: 40,
            axisLabel: { formatter: "{value}â„ƒ", fontSize: 10 },
          },
          series: [
            {
              data: Temps,
              type: "line",
              smooth: true,
              lineStyle: { color: "#ff7e00", width: 3 },
              itemStyle: { color: "#ff7e00" },
              areaStyle: {
                color: {
                  type: "linear",
                  x: 0,
                  y: 0,
                  x2: 0,
                  y2: 1,
                  colorStops: [
                    { offset: 0, color: "rgba(255, 126, 0, 0.3)" },
                    { offset: 1, color: "rgba(255, 126, 0, 0.1)" },
                  ],
                },
              },
            },
          ],
          grid: { left: "13%", right: "10%", top: "20%", bottom: "15%" },
        };
        tempChart.setOption(tempOption);
      };

      //å…‰ç…§æ¨¡å—
      // åˆå§‹åŒ–å…‰ç…§æŠ˜çº¿å›¾
      const sunChart = echarts.init(document.getElementById("sunChart"));

      // // æ›´æ–°ä»Šæ—¥å…‰ç…§æ˜¾ç¤º
      // const updateTodaySun = async () => {
      //     const data = await HUMIDITY_API.getSensorData();
      //     let todaySun = '--';
      //     if (data.sun && data.sun.length > 0) {
      //         todaySun = data.sun[data.sun.length - 1];
      //     } else {
      //         todaySun = 1000; // è‡ªå®šä¹‰é»˜è®¤å€¼
      //     }
      //     document.getElementById('todaySun').textContent = todaySun;
      // };

      // æ›´æ–°å…‰ç…§æŠ˜çº¿å›¾ï¼ˆä¸ƒå¤©ï¼‰
      const updateSunChart = async () => {
        const data = await HUMIDITY_API.getSensorData();
        let Suns = [];
        let dates = [];
        if (
          data.sun &&
          data.sun.length > 0 &&
          data.date &&
          data.date.length > 0
        ) {
          const len = data.date.length;
          dates = len >= 7 ? data.date.slice(len - 7) : data.date;
          Suns = data.sun;
        } else {
          // è‡ªå®šä¹‰é»˜è®¤å€¼
          dates = [
            "12-01",
            "12-02",
            "12-03",
            "12-04",
            "12-05",
            "12-06",
            "12-07",
          ];
          Suns = [800, 1200, 1500, 900, 1000, 1100, 950];
        }

        const sunOption = {
          title: { text: "", left: "center" },
          tooltip: { trigger: "axis", formatter: "{b}: {c}lux" },
          xAxis: { type: "category", data: dates, axisLabel: { fontSize: 10 } },
          yAxis: {
            type: "value",
            min: 0,
            max: 400,
            axisLabel: { formatter: "{value}lux", fontSize: 10 },
          },
          series: [
            {
              data: Suns,
              type: "line",
              smooth: true,
              lineStyle: { color: "#f7b500", width: 3 },
              itemStyle: { color: "#f7b500" },
              areaStyle: {
                color: {
                  type: "linear",
                  x: 0,
                  y: 0,
                  x2: 0,
                  y2: 1,
                  colorStops: [
                    { offset: 0, color: "rgba(247, 181, 0, 0.3)" },
                    { offset: 1, color: "rgba(247, 181, 0, 0.1)" },
                  ],
                },
              },
            },
          ],
          grid: { left: "13%", right: "10%", top: "20%", bottom: "15%" },
        };
        sunChart.setOption(sunOption);
      };

      //åœŸå£¤æ¹¿åº¦æ¨¡å—
      // åˆå§‹åŒ–åœŸå£¤æ¹¿åº¦å †å é¢ç§¯å›¾
      const soilChart = echarts.init(document.getElementById("soilChart"));

      // è·å–ä¸‰å±‚åœŸå£¤æ¹¿åº¦æ•°æ®å¹¶æ¸²æŸ“
      const updateSoilChart = async () => {
        const data = await HUMIDITY_API.getSensorData();
        let dates = [];
        let tsoil = [[], [], []];
        if (data.date && data.date.length > 0) {
          const len = data.date.length;
          dates = len >= 7 ? data.date.slice(len - 7) : data.date;
          for (let i = 0; i < 3; i++) {
            const key = "tsoil" + (i + 1);
            // ä¿è¯æ¯å±‚æ•°æ®é•¿åº¦å’Œdatesä¸€è‡´ï¼Œä¸”æœ‰é»˜è®¤å€¼
            if (data[key] && data[key].length > 0) {
              const arr = len >= 7 ? data[key].slice(len - 7) : data[key];
              tsoil[i] =
                arr.length === dates.length
                  ? arr
                  : Array(dates.length).fill(10 + i * 2);
            } else {
              tsoil[i] = Array(dates.length).fill(10 + i * 2);
            }
          }
        } else {
          // é»˜è®¤æ•°æ®
          dates = [
            "12-01",
            "12-02",
            "12-03",
            "12-04",
            "12-05",
            "12-06",
            "12-07",
          ];
          tsoil = [
            [20, 22, 21, 23, 22, 21, 20],
            [18, 19, 20, 21, 20, 19, 18],
            [15, 16, 17, 18, 17, 16, 15],
          ];
        }

        const colors = [
          ["#1890ff", "#a0cfff"],
          ["#13c2c2", "#8ce8e8"],
          ["#52c41a", "#b7eb8f"],
        ];

        const series = [];
        for (let i = 0; i < 3; i++) {
          series.push({
            name: `åœŸå£¤${i + 1}å±‚`,
            type: "line",
            stack: "Total",
            smooth: true,
            symbol: "circle",
            symbolSize: 6,
            lineStyle: { width: 2 },
            areaStyle: {
              opacity: 0.7,
              color: {
                type: "linear",
                x: 0,
                y: 0,
                x2: 0,
                y2: 1,
                colorStops: [
                  { offset: 0, color: colors[i][0] },
                  { offset: 1, color: colors[i][1] },
                ],
              },
            },
            itemStyle: { color: colors[i][0] },
            emphasis: { focus: "series" },
            data: tsoil[i],
          });
        }

        const soilOption = {
          tooltip: { trigger: "axis" },
          legend: {
            data: ["åœŸå£¤1å±‚", "åœŸå£¤2å±‚", "åœŸå£¤3å±‚"],
            bottom: 0,
            icon: "circle",
            itemWidth: 10,
            itemHeight: 10,
            textStyle: { fontSize: 11 },
            type: "plain",
          },
          grid: { left: "8%", right: "8%", top: 30, bottom: 40 },
          xAxis: {
            type: "category",
            boundaryGap: false,
            data: dates,
            axisLabel: { fontSize: 12, interval: 0, rotate: 0 },
          },
          yAxis: {
            type: "value",
            axisLabel: { fontSize: 12 },
            min: 0,
            max: 80,
          },
          series,
        };
        soilChart.setOption(soilOption);
      };

      //äº§é‡æ¨¡å—
      // åˆå§‹åŒ–äº§é‡æŸ±å½¢å›¾
      const yieldChart = echarts.init(document.getElementById("yieldChart"));

      // æ›´æ–°äº§é‡æŸ±å½¢å›¾
      const updateYieldChart = async () => {
        const data = await YIELD_API.getYieldData();

        // // ä½¿ç”¨åç«¯æ•°æ®
        // const yieldData = data.day.map((name, index) => ({
        //     name: name,
        //     value: data.output[index] || 0,
        //     type: data.type[index] || 'å…¶ä»–'
        // }));
        const types = data.type || [];
        const outputs = data.output || [];

        const yieldOption = {
          // tooltip: {
          //     trigger: 'axis',
          //     formatter: function(params) {
          //         const data = params[0];
          //         const index = data.dataIndex;
          //         const price = data.output && data.output[index] ? data.output[index] : 0;
          //         return `${data.name}<br/>äº§é‡: ${data.value}å¨<br/>ä»·æ ¼: ${price}å…ƒ/æ–¤`;
          //     }
          // },
          tooltip: {
            trigger: "axis",
            axisPointer: { type: "shadow" },
            formatter: function (params) {
              const param = params[0];
              const index = param.dataIndex;
              const typeName = param.name;
              const outputValue = param.value;
              const price =
                data.price && data.price[index] ? data.price[index] : "N/A";
              return `${typeName}<br/>äº§é‡: ${outputValue}å¨<br/>ä»·æ ¼: ${price}å…ƒ/æ–¤`;
            },
          },
          grid: {
            left: "15%",
            right: "8%",
            top: "15%",
            bottom: "15%",
          },
          xAxis: {
            type: "category",
            data: types,
            axisLabel: {
              fontSize: 10,
              interval: 0,
              rotate: 0,
            },
          },
          yAxis: {
            type: "value",
            axisLabel: {
              fontSize: 9,
              formatter: "{value}å¨",
              margin: 8,
            },
            axisTick: {
              alignWithLabel: true,
            },
          },
          series: [
            {
              data: outputs,
              type: "bar",
              barWidth: "60%",
              itemStyle: {
                color: {
                  type: "linear",
                  x: 0,
                  y: 0,
                  x2: 0,
                  y2: 1,
                  colorStops: [
                    { offset: 0, color: "#52c41a" },
                    { offset: 1, color: "#95de64" },
                  ],
                },
              },
              emphasis: {
                itemStyle: {
                  color: {
                    type: "linear",
                    x: 0,
                    y: 0,
                    x2: 0,
                    y2: 1,
                    colorStops: [
                      { offset: 0, color: "#389e0d" },
                      { offset: 1, color: "#73d13d" },
                    ],
                  },
                },
              },
            },
          ],
        };
        yieldChart.setOption(yieldOption);
      };

      //æ”¶æˆå¤©æ•°æ¨¡å—
      // åˆå§‹åŒ–æ”¶æˆå¤©æ•°æŸ±å½¢å›¾
      const harvestChart = echarts.init(
        document.getElementById("harvestChart")
      );

      // æ›´æ–°æ”¶æˆå¤©æ•°æŸ±å½¢å›¾
      const updateHarvestChart = async () => {
        const data = await YIELD_API.getYieldData();

        // æ„é€ å¸¦è¿›åº¦çš„æ•°æ®
        const harvestData = data.type.map((name, index) => {
          const total = data.day[index] || 90; //æ€»ç”Ÿé•¿æ—¶é—´
          //const grown = Math.floor(Math.random() * total);        //å·²ç”Ÿé•¿æ—¶é—´
          const grown = data.grown[index] || 0; //å·²ç”Ÿé•¿æ—¶é—´
          const percent = Math.round((grown / total) * 100); //ç™¾åˆ†æ¯”
          return {
            name,
            total,
            grown,
            percent,
          };
        });

        const harvestOption = {
          tooltip: {
            trigger: "axis",
            axisPointer: {
              type: "shadow",
            },
            formatter: (params) => {
              const item = params[0];
              return `
          <div style="font-size:14px;color:#333">
            <b>${item.data.name}</b><br/>
            å·²ç”Ÿé•¿ï¼š<b>${item.data.grown}å¤©</b><br/>
            æ€»å‘¨æœŸï¼š<b>${item.data.total}å¤©</b><br/>
            è¿›åº¦ï¼š<b>${item.data.percent}%</b>
          </div>
        `;
            },
          },
          grid: {
            left: "12%",
            right: "18%",
            top: "5%",
            bottom: "5%",
          },
          xAxis: {
            type: "value",
            max: 100,
            axisLabel: {
              show: false,
              fontSize: 10,
              color: "#666",
            },
            splitLine: {
              show: false,
              lineStyle: {
                type: "dashed",
                color: "#ddd",
              },
            },
          },
          yAxis: [
            //å·¦ä¾§yè½´
            {
              type: "category",
              data: harvestData.map((d) => `${d.name}`),
              axisLabel: {
                fontSize: 12,
                color: "#333",
                width: 80,
                interval: 0,
                overflow: "truncate",
              },
              axisLine: {
                show: false,
              },
              axisTick: {
                show: false,
              },
            },
            //å³ä¾§yè½´
            {
              type: "category",
              position: "right",
              data: harvestData.map((d) => `${d.total}å¤©`),
              axisLine: {
                show: false,
              },
              axisTick: {
                show: false,
              },
              axisLabel: {
                fontSize: 12,
                color: "#666",
                padding: [0, 0, 0, 15], // å¢åŠ å·¦ä¾§å†…è¾¹è·
              },
            },
          ],
          series: [
            // èƒŒæ™¯æ€»é•¿åº¦
            {
              type: "bar",
              barWidth: 18,
              barGap: "-100%",
              data: harvestData.map((d) => ({
                value: 100,
                name: d.name, // æ·»åŠ nameå±æ€§
                grown: d.grown, // æ·»åŠ grownå±æ€§
                total: d.total, // æ·»åŠ totalå±æ€§
                percent: d.percent, // æ·»åŠ percentå±æ€§
                itemStyle: {
                  color: "#f0f0f0",
                  borderRadius: [0, 10, 10, 0],
                  borderWidth: 1,
                  borderColor: "#ddd",
                },
              })),
              z: 1,
            },
            // å·²ç”Ÿé•¿è¿›åº¦
            {
              type: "bar",
              barWidth: 18,
              barGap: "-100%",
              data: harvestData.map((d) => {
                // æ ¹æ® percent åŠ¨æ€ç”Ÿæˆé¢œè‰²
                const colorStops =
                  d.percent < 30
                    ? [
                        {
                          offset: 0,
                          color: "#ffa940",
                        },
                        {
                          offset: 1,
                          color: "#ffd591",
                        },
                      ]
                    : d.percent < 50
                    ? [
                        {
                          offset: 0,
                          color: "#ffec3d",
                        },
                        {
                          offset: 1,
                          color: "#fff566",
                        },
                      ]
                    : [
                        {
                          offset: 0,
                          color: "#52c41a",
                        },
                        {
                          offset: 1,
                          color: "#95de64",
                        },
                      ];

                return {
                  value: d.percent,
                  name: d.name,
                  grown: d.grown,
                  total: d.total,
                  percent: d.percent,
                  itemStyle: {
                    color: {
                      type: "linear",
                      x: 0,
                      y: 0,
                      x2: 1,
                      y2: 0,
                      colorStops,
                    },
                    borderRadius: [0, 10, 10, 0],
                    shadowColor: "rgba(0, 150, 0, 0.3)",
                    shadowBlur: 5,
                  },
                  label: {
                    show: true,
                    position: d.percent > 75 ? "insideRight" : "right",
                    formatter: (param) => {
                      const icon =
                        param.data.percent < 30
                          ? "ğŸŸ "
                          : param.data.percent < 50
                          ? "ğŸŸ¡"
                          : "ğŸŸ¢";
                      return `${param.data.percent}% ${icon}`;
                    },
                    fontSize: 12,
                    fontWeight: "bold",
                    color: "#333",
                    distance: 8,
                  },
                };
              }),
              z: 2,
            },
          ],
        };

        harvestChart.setOption(harvestOption);
      };

      // æ›´æ–°å†œäº§å“ä»·æ ¼å’Œé”€é‡å±•ç¤º
      const updateProductStats = async () => {
        const data = await YIELD_API.getYieldData();
        const statsGrid = document.getElementById("statsGrid");

        if (!data.day || !data.price || !data.xiaoliang) {
          console.error("æ•°æ®æ ¼å¼é”™è¯¯");
          return;
        }

        let html = "";
        for (let i = 0; i < data.type.length; i++) {
          const productName = data.type[i];
          const xiaoliang = data.xiaoliang[i] || 0;
          const price = data.price[i] || 0;

          // åŒä¸€äº§å“çš„ä»·æ ¼å’Œé”€é‡æ¨ªå‘æ’åˆ—
          html += `
                    <div class="stat-item">
                        <div class="product-name">${productName}</div>
                        <div class="stats-row">
                            <div class="price-section">
                                <div class="stat-icon">ğŸ’°</div>
                                <div class="stat-label">ä»·æ ¼</div>
                                <div class="stat-value">Â¥${price}/æ–¤</div>
                            </div>
                            <div class="output-section">
                                <div class="stat-icon">ğŸ“ˆ</div>
                                <div class="stat-label">é”€é‡</div>
                                <div class="stat-value">${xiaoliang}å¨</div>
                            </div>
                        </div>
                    </div>
                `;
        }

        statsGrid.innerHTML = html;
      };

      // åˆå§‹åŒ–æ‰€æœ‰æ•°æ®
      const initPanelData = async () => {
        //await updateTodayHumidity();
        await updateHumidityChart();
        //await updateTodayTemp();
        await updateTempChart();
        //await updateTodaySun();
        await updateSunChart();
        await updateSoilChart();
        await updateYieldChart();
        await updateHarvestChart();
        await updateProductStats();
        await updatetodayWeatherDisplay();
      };

      // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–æ•°æ®
      initPanelData();

      // å®šæ—¶æ›´æ–°
      //setInterval(initPanelData, 5 * 60 * 1000);

      // å®æ—¶æ—¶é—´æ›´æ–°åŠŸèƒ½
      var t = setTimeout(showtime, 1000);
      function showtime() {
        clearTimeout(t);
        var d = new Date();
        var y = d.getFullYear();
        var m = d.getMonth() + 1;
        var day = d.getDate();
        var h = d.getHours();
        var min = d.getMinutes();
        var s = d.getSeconds();
        document.getElementById("showtime").innerHTML =
          y + "å¹´" + m + "æœˆ" + day + "æ—¥ " + h + "æ—¶" + min + "åˆ†" + s + "ç§’";
        t = setTimeout(showtime, 1000);
      }

      // é¡µé¢çª—å£å˜åŒ–æ—¶è‡ªé€‚åº”
      window.addEventListener("resize", function () {
        myChart.resize();
        humidityChart.resize();
        tempChart.resize();
        sunChart.resize();
        soilChart.resize();
        yieldChart.resize();
        harvestChart.resize();
      });
    </script>
  </body>
</html>
